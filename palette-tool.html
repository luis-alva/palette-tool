<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Palette Tool</title>
  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAF8UlEQVRYCe1WS2wbRRj+ZnbXu37k5YY2SZWqShMeDS1BrahUVfTSA6fCgRMXbgj1xIkeOCGBkJBaJMSt3BASKuKGQEhI9ADiQEWrQqoSWkpfcR527Hg3XntfwzcbO3VqqyAuHOjYszue1/f93//PPwYelf+7AuJfCCBGJyfH4YeP79xZPBRF0fja2trZcrm8+C/2wt8SmJiYGCXITALjGb8lDiulDlqG2pd14qLj5JHP5VGt1s5nhPVeM27WNgzDde/d2yCZ5j8h1JfA+Pj4U77vvxZE0WHLMGecbHZXzonx3GwLB/ZFODAdYmoixqn3h3FnZQRB2ICdtRNLWr6KY88Q0bpAUoUSZUCVFbAaJfLa9UbzMywva3JbxdxqtRtjY2OPJUny5f7Z2am5uWcxPTONnWN7sXr1bbzx8iVAtidGQCELxKGC80QOe14ZkmYU5W99M5Jfap7cZcGFGdVhhC6MyENu4yamRenQdeBUN2YPAcq937adqTdPn8bs7NOI4ggNihmVckTj0nBzuaJZ/PKhIB0Dub02HFvA/H03vPqLkHY6yjn8CAvFG5+gWD/3PFcYrHqntPQhAJnNClhWBmEUIo5jJImhce4XOk5QCdlxoB6LCURVRMxoiZqQRnuBoDMMYhoOEqWS+5tstnoIoN3DdQSQUFLBMk1Wdtg0mArUfWBpRaLqik0SJCM4LogjpIRUuraN1DyE0l+WNqlN7PTZS4BWgOgZghpI0PBc3F2q4MefXAwsOWjdziCzZCC/xtFlLuc3diN4v/kIczGapRqSVhmxQ4ulTQMsKDODOOoETxc6mz0EiIsoDPDFt9/DmpjBcmSjbA5iZiGPYxdzyGVM0OWUR+EDyrxIowxLwCgYjBeJ/YXL+Oj4S6hHBVT8Aqr+ACrBCC6V1nEztrQE22ToIaD5KWlifs8JDD55BCYlzdF1Ezs+RDGIEZChjkMdEx2HSptBOJGhORJTNYkXjlTYZtUxouHounNGFm9dHp/kEZ8slUq32JuWPrpE9KMBZ3AEFqNMxCH9HugA6qx54M1+TYZsFAORhwYI2rXVfpNxxECmMcNCiGL3Bn0ItIeTNmAbWBujS4ZoFhWJGO1MAZsWclAHrba489ZzHywN3094zDvCpcN9XaBHdDRrJRIRIwyaqLYCLLTo89jAuunAyzhYEV6al1RIMl7MfCDR4hyNQC/yoTdipQtMU8HgfkwkbcvYZOlDwIRKYmzcvgbbr2I4qGAKG6hEPspTc9hdKGDOyWDQkPh0/Qp+bTLyeQL+fKeSJqRSPcG7vxSRKyRwnATZnEJ+KMEPP9vIOqagNzWlrdKHAMeYfF4dW8eJ4wdRHJ6BmS/g62sXcNRbolXaCirfiQm9Hf0uPROiYWIAFgSPqUc766yJYq6g29bWJdvBnSAIbqUbtB89BOgj5PJ5HD92FHun9lH+AD4jLErDntmOsm4zQW/EDqEDltwkAQ3KTQemB0A/eTgw0JLslzWWejeB/kFIsDAMGdkxl9OMLsTNJsEIuJWK2yS6J3Ycrd+dyobG24bZo4Deq7NYt3lswCsZGfo8ReRgOWhhvubhrh+wS+dLDc0P52qCeqrepLOP7ktPxzZodrL0JaAHbNuGpL/rdRcLN27gq6sLuLi2gisbTfzBWg4jGLxkkqiVvrXrBJWrhTHuMgAydIeWnkkSzFPgQUkJ6r27Sw8Bbiq0/GfOnAXPLebn51FaXESTgDGPpklTdJWsMft0KfBkOFmHJjMRmUO44GqdqTdvIN6jtJIuFSbjw+vRoIdAqFTDIdD5859rXXkLWlRC0iJaywSU8IRETFKdUyAZCHXXhet5qYX6BtV96a2oc4kmy7fiXb3heVXy3fovoMlr9zxYnB2jox8T+CSD0I9jtcJrfDGBukNn31YqvkcvC7p+iL+HuHiwXQeINch5A9w0T6NzBOe/GOWQRYbc+ac1eZ2n4LtuwH4E0vGRkZE99GvDdd0aOza17l758LZOFpnh4WGb7rQty3JYK6urq97Dlz0afaTAf6DAX3YrejeSkMB0AAAAAElFTkSuQmCC">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .palette-name {
      background: transparent;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 18px;
      color: #fff;
      min-width: 200px;
    }

    .palette-name:focus {
      outline: none;
      border-color: #6c63ff;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-left: auto;
    }

    label {
      font-size: 14px;
      color: #aaa;
    }

    select, button {
      background: #2d2d44;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px 12px;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }

    select:hover, button:hover {
      background: #3d3d54;
    }

    button.primary {
      background: #6c63ff;
      border-color: #6c63ff;
    }

    button.primary:hover {
      background: #5a52d5;
    }

    button.danger {
      background: #dc3545;
      border-color: #dc3545;
    }

    button.danger:hover {
      background: #c82333;
    }

    /* Grid */
    .grid-wrapper {
      position: relative;
      width: fit-content;
      max-width: 100%;
    }

    .grid-container {
      background: #2d2d44;
      border-radius: 12px;
      padding: 20px;
      padding-bottom: 28px;
      width: 600px;
      height: 400px;
      min-width: 200px;
      min-height: 150px;
      max-width: calc(100vw - 60px);
      max-height: calc(100vh - 200px);
      resize: both;
      overflow: hidden;
      position: relative;
    }

    .squares-toggle {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      font-size: 12px;
      color: #888;
      user-select: none;
      z-index: 5;
      background: rgba(45, 45, 68, 0.9);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .squares-toggle input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: #6c63ff;
    }

    .squares-toggle:hover {
      color: #aaa;
    }

    .grid-container::after {
      content: '';
      position: absolute;
      bottom: 4px;
      right: 4px;
      width: 16px;
      height: 16px;
      background: linear-gradient(135deg, transparent 50%, #555 50%, #555 60%, transparent 60%, transparent 70%, #555 70%, #555 80%, transparent 80%);
      pointer-events: none;
      opacity: 0.6;
    }

    .color-grid {
      display: grid;
      gap: 8px;
      position: relative;
      width: 100%;
    }

    /* Grid area wrapper for positioning controls */
    .grid-area {
      position: relative;
      display: inline-block;
      margin-top: 24px;
    }

    /* Grid edge controls */
    .grid-controls {
      position: absolute;
      display: flex;
      opacity: 0;
      transition: opacity 0.15s;
      pointer-events: none;
      z-index: 10;
    }

    .grid-container:hover .grid-controls {
      opacity: 1;
      pointer-events: auto;
    }

    .grid-controls.top {
      bottom: 100%;
      left: 0;
      right: 0;
      height: 16px;
      margin-bottom: 2px;
    }

    .grid-controls.bottom {
      top: 100%;
      left: 0;
      right: 0;
      height: 16px;
      margin-top: 2px;
      justify-content: center;
    }

    .grid-controls.left {
      right: 100%;
      top: 0;
      bottom: 0;
      width: 16px;
      flex-direction: column;
      margin-right: 2px;
    }

    .grid-controls.right {
      left: 100%;
      top: 0;
      bottom: 0;
      width: 16px;
      flex-direction: column;
      margin-left: 2px;
      justify-content: center;
    }

    .grid-ctrl-btn {
      background: transparent;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.15s;
      flex: 1;
      min-width: 14px;
      min-height: 14px;
    }

    .grid-ctrl-btn:hover {
      color: #fff;
    }

    .grid-ctrl-btn.delete:hover {
      color: #e55;
    }

    .grid-ctrl-btn.add {
      color: #555;
      font-size: 14px;
    }

    .grid-ctrl-btn.add:hover {
      color: #8f8;
    }

    .grid-cell-wrapper {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: visible;
      min-width: 0;
      min-height: 0;
    }

    .interp-btn {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #6c63ff;
      border: 2px solid #2d2d44;
      color: #fff;
      font-size: 14px;
      line-height: 1;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.15s, transform 0.15s;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .interp-btn.right {
      right: 0;
      top: 50%;
      transform: translate(50%, -50%);
    }

    .interp-btn.bottom {
      bottom: 0;
      left: 50%;
      transform: translate(-50%, 50%);
    }

    .grid-cell-wrapper:hover .interp-btn {
      opacity: 1;
    }

    .interp-btn.right:hover {
      background: #5a52d5;
      transform: translate(50%, -50%) scale(1.15);
    }

    .interp-btn.bottom:hover {
      background: #5a52d5;
      transform: translate(-50%, 50%) scale(1.15);
    }

    .color-cell {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: transform 0.15s, border-color 0.15s;
      min-width: 24px;
      min-height: 24px;
    }

    .color-cell:hover {
      transform: scale(1.02);
      border-color: #fff;
    }

    .color-cell.dragging {
      opacity: 0.5;
      transform: scale(0.95);
    }

    .color-cell.group-dragging {
      opacity: 0.4;
      outline: 2px dashed #6c63ff;
      outline-offset: -2px;
    }

    .drag-count-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #6c63ff;
      color: #fff;
      font-size: 11px;
      font-weight: bold;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: none;
    }

    .color-cell.drag-over {
      border-color: #6c63ff;
      box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.4);
    }

    .color-cell.selected {
      border-color: #6c63ff;
      box-shadow: 0 0 0 2px #6c63ff;
    }

    .color-cell.multi-selected {
      border-color: #6c63ff;
      box-shadow: 0 0 0 2px rgba(108, 99, 255, 0.6);
    }

    .color-cell.empty {
      background: #1a1a2e;
      border: 2px dashed #444;
    }

    .color-cell.empty:hover {
      border-color: #6c63ff;
    }

    .add-color-btn {
      width: 100%;
      height: 100%;
      border-radius: 8px;
      background: #1a1a2e;
      border: 2px dashed #444;
      color: #666;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      min-height: 24px;
    }

    .add-color-btn:hover {
      border-color: #6c63ff;
      color: #6c63ff;
    }

    /* Popup */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .popup-overlay.active {
      display: flex;
    }

    /* Edit popup positioned left to leave room for color picker */
    .popup-overlay.edit-popup.active {
      justify-content: flex-start;
      padding-left: 40px;
    }

    .popup {
      background: #2d2d44;
      border-radius: 12px;
      padding: 24px;
      min-width: 300px;
      max-width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
    }

    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .popup-title {
      font-size: 18px;
      font-weight: 600;
    }

    .close-btn {
      background: none;
      border: none;
      color: #888;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .close-btn:hover {
      color: #fff;
    }

    /* Color Editor */
    .color-preview-wrapper {
      position: relative;
      margin-bottom: 16px;
    }

    .color-preview {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.15s;
      position: relative;
    }

    .color-preview:hover {
      box-shadow: 0 0 0 2px #6c63ff;
    }

    .color-picker-overlay {
      position: absolute;
      top: 0;
      right: 0;
      width: 50%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      border: none;
    }

    /* Clickable hint on color preview */
    .color-preview::after {
      content: 'Click to pick';
      position: absolute;
      bottom: 4px;
      right: 8px;
      font-size: 10px;
      color: rgba(255,255,255,0.5);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .color-preview:hover::after {
      opacity: 1;
    }

    .hex-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      align-items: center;
    }

    .hex-input {
      flex: 1;
      background: #1a1a2e;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 12px;
      color: #fff;
      font-family: monospace;
      font-size: 18px;
      text-transform: uppercase;
      text-align: center;
    }

    .hex-input:focus {
      outline: none;
      border-color: #6c63ff;
    }

    .mode-toggle-btn {
      background: #1a1a2e;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px 16px;
      color: #aaa;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      min-width: 50px;
    }

    .mode-toggle-btn:hover {
      border-color: #6c63ff;
      color: #fff;
    }

    .hsl-sliders {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slider-row label {
      width: 16px;
      font-weight: 600;
      color: #888;
    }

    .slider-row input[type="range"] {
      flex: 1;
      height: 8px;
      -webkit-appearance: none;
      background: #1a1a2e;
      border-radius: 4px;
      cursor: pointer;
    }

    .slider-row input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #6c63ff;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #fff;
    }

    .slider-row span {
      min-width: 44px;
      text-align: right;
      font-size: 13px;
      color: #aaa;
      font-family: monospace;
    }

    .color-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .color-name-label {
      color: #666;
      font-size: 12px;
      white-space: nowrap;
    }

    .color-name-input-wrapper {
      flex: 1;
      position: relative;
    }

    .color-name-input {
      width: 100%;
      background: #1a1a2e;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px 12px;
      color: #aaa;
      font-size: 14px;
    }

    .color-name-input:focus {
      outline: none;
      border-color: #6c63ff;
      color: #fff;
    }

    .color-name-dropdown {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #2d2d44;
      border: 1px solid #444;
      border-radius: 6px;
      margin-top: 4px;
      z-index: 200;
      max-height: 200px;
      overflow-y: auto;
    }

    .color-name-dropdown.active {
      display: block;
    }

    .color-name-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }

    .color-name-option:hover {
      background: #3d3d54;
    }

    .color-name-swatch {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .color-name-text {
      color: #eee;
      font-size: 13px;
    }

    .rgb-sliders {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    /* Hue slider gradient */
    #hueSlider {
      background: linear-gradient(to right,
        hsl(0, 100%, 50%), hsl(60, 100%, 50%), hsl(120, 100%, 50%),
        hsl(180, 100%, 50%), hsl(240, 100%, 50%), hsl(300, 100%, 50%), hsl(360, 100%, 50%));
    }

    .popup-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .popup-actions button {
      flex: 1;
    }

    /* Export Popup */
    .export-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .export-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #1a1a2e;
      border-radius: 8px;
    }

    .export-option span {
      color: #888;
      font-size: 13px;
    }

    /* Import options */
    .import-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .import-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #1a1a2e;
      border-radius: 8px;
    }

    .import-option span {
      color: #888;
      font-size: 13px;
    }

    /* Info */
    .info {
      margin-top: 20px;
      color: #666;
      font-size: 13px;
    }

    .batch-edit-btn {
      margin-left: 12px;
      padding: 4px 12px;
      border-radius: 6px;
      border: 1px solid #6c63ff;
      background: transparent;
      color: #6c63ff;
      cursor: pointer;
      font-size: 12px;
    }
    .batch-edit-btn:hover { background: #6c63ff22; }

    .batch-preview-row {
      display: flex;
      gap: 3px;
      margin-bottom: 16px;
      height: 36px;
      border-radius: 6px;
      overflow: hidden;
    }
    .batch-preview-swatch {
      flex: 1;
      min-width: 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <input type="text" class="palette-name" id="paletteName" value="My Palette" placeholder="Palette name">
    <div class="header-controls">
      <button id="randomFillBtn">Random</button>
      <label>
        Grid:
        <select id="gridSize">
          <option value="8x1">8×1</option>
          <option value="8x2">8×2</option>
          <option value="4x4" selected>4×4</option>
          <option value="8x4">8×4</option>
          <option value="8x8">8×8</option>
          <option value="16x8">16×8</option>
          <option value="16x16">16×16</option>
          <option value="32x4">32×4</option>
        </select>
      </label>
      <label>
        Sort:
        <select id="sortColors">
          <option value="">—</option>
          <option value="hue">Hue</option>
          <option value="saturation">Saturation</option>
          <option value="lightness">Lightness</option>
          <option value="luminance">Luminance</option>
        </select>
      </label>
      <button id="importBtn">Import</button>
      <button id="exportBtn">Export</button>
    </div>
  </div>

  <div class="grid-wrapper">
    <div class="grid-container" id="gridContainer">
      <label class="squares-toggle">
        <input type="checkbox" id="squaresToggle" checked>
        <span>Squares</span>
      </label>
      <div class="grid-area" id="gridArea">
        <div class="grid-controls top" id="topControls"></div>
        <div class="grid-controls left" id="leftControls"></div>
        <div class="color-grid" id="colorGrid"></div>
        <div class="grid-controls right" id="rightControls"></div>
        <div class="grid-controls bottom" id="bottomControls"></div>
      </div>
    </div>
  </div>

  <p class="info">
    Click to edit. Drag to reorder. Hover + to interpolate. <span id="overflowWarning" style="display:none; color: #c45; margin-left: 4px;">Not all colors visible.</span><br>
    <span style="color: #888;">Cmd/Ctrl+click to multi-select. Shift+click for range. Delete to remove. Cmd/Ctrl+C/V to copy/paste.</span>
    <button id="batchEditBtn" class="batch-edit-btn" style="display:none;" onclick="openBatchEdit()">Adjust Selected</button>
  </p>

  <!-- Color Edit Popup -->
  <div class="popup-overlay edit-popup" id="editPopup">
    <div class="popup">
      <div class="popup-header">
        <span class="popup-title">Edit Color</span>
        <button class="close-btn" onclick="closeEditPopup()">&times;</button>
      </div>
      <div class="color-preview-wrapper">
        <div class="color-preview" id="colorPreview"></div>
        <input type="color" id="colorPicker" class="color-picker-overlay">
      </div>
      <div class="hex-row">
        <input type="text" class="hex-input" id="hexInput" placeholder="#FF5733" maxlength="7">
        <button class="mode-toggle-btn" id="modeToggle" onclick="toggleSliderMode()">⇄ RGB</button>
      </div>
      <div class="color-name-row" id="colorNameRow">
        <span class="color-name-label">Nearest:</span>
        <div class="color-name-input-wrapper">
          <input type="text" class="color-name-input" id="colorNameInput" placeholder="Type color name...">
          <div class="color-name-dropdown" id="colorNameDropdown"></div>
        </div>
      </div>
      <div class="hsl-sliders" id="hslSliders">
        <div class="slider-row">
          <label>H</label>
          <input type="range" id="hueSlider" min="0" max="360" value="0">
          <span id="hueValue">0°</span>
        </div>
        <div class="slider-row">
          <label>S</label>
          <input type="range" id="satSlider" min="0" max="100" value="50">
          <span id="satValue">50%</span>
        </div>
        <div class="slider-row">
          <label>L</label>
          <input type="range" id="lightSlider" min="0" max="100" value="50">
          <span id="lightValue">50%</span>
        </div>
      </div>
      <div class="rgb-sliders" id="rgbSliders" style="display:none;">
        <div class="slider-row">
          <label>R</label>
          <input type="range" id="redSlider" min="0" max="255" value="128">
          <span id="redValue">128</span>
        </div>
        <div class="slider-row">
          <label>G</label>
          <input type="range" id="greenSlider" min="0" max="255" value="128">
          <span id="greenValue">128</span>
        </div>
        <div class="slider-row">
          <label>B</label>
          <input type="range" id="blueSlider" min="0" max="255" value="128">
          <span id="blueValue">128</span>
        </div>
      </div>
      <div class="popup-actions">
        <button class="danger" onclick="deleteColor()">Delete</button>
        <button onclick="duplicateColor()">Duplicate</button>
        <button class="primary" onclick="saveColor()">Save</button>
      </div>
    </div>
  </div>

  <!-- Import Popup -->
  <div class="popup-overlay" id="importPopup">
    <div class="popup" style="min-width: min(400px, 90vw);">
      <div class="popup-header">
        <span class="popup-title">Import Palette</span>
        <button class="close-btn" onclick="closeImportPopup()">&times;</button>
      </div>
      <div class="import-options">
        <div class="import-option">
          <div>
            <strong>Extract from Image</strong><br>
            <span>K-means clustering to find dominant colors</span>
          </div>
          <input type="file" id="imageInput" accept="image/*" style="display:none" onchange="showExtractOptions(this)">
          <button onclick="document.getElementById('imageInput').click()">Choose Image</button>
        </div>
        <div class="import-option">
          <div>
            <strong>PNG Palette Strip</strong><br>
            <span>Load colors from a horizontal strip image</span>
          </div>
          <input type="file" id="pngInput" accept=".png" style="display:none" onchange="importPNG(this)">
          <button onclick="document.getElementById('pngInput').click()">Choose File</button>
        </div>
        <div class="import-option">
          <div>
            <strong>HEX File</strong><br>
            <span>Load from text file (one hex per line)</span>
          </div>
          <input type="file" id="hexFileInput" accept=".hex,.txt" style="display:none" onchange="importHexFile(this)">
          <button onclick="document.getElementById('hexFileInput').click()">Choose File</button>
        </div>
      </div>
      <!-- Extract options (hidden by default) -->
      <div id="extractOptions" style="display:none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #444;">
        <canvas id="previewCanvas" style="max-width: 100%; border-radius: 8px; margin-bottom: 12px;"></canvas>
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
          <label style="flex: 1;">
            Number of colors:
            <input type="range" id="kValue" min="2" max="32" value="8" style="width: 100%;">
          </label>
          <span id="kDisplay" style="min-width: 30px;">8</span>
        </div>
        <div style="display: flex; gap: 16px; margin-bottom: 12px;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="extractMode" value="standard" checked>
            Standard
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="extractMode" value="outlier">
            Outlier-aware
          </label>
        </div>
        <button class="primary" onclick="extractColors()" style="width: 100%;">Extract Colors</button>
      </div>
    </div>
  </div>

  <!-- Export Popup -->
  <div class="popup-overlay" id="exportPopup">
    <div class="popup">
      <div class="popup-header">
        <span class="popup-title">Export Palette</span>
        <button class="close-btn" onclick="closeExportPopup()">&times;</button>
      </div>
      <div class="export-options">
        <div class="export-option">
          <div>
            <strong>PNG Strip</strong><br>
            <span>Visual reference image</span>
          </div>
          <button onclick="exportPNG()">Download</button>
        </div>
        <div class="export-option">
          <div>
            <strong>Procreate</strong><br>
            <span>.swatches for iPad</span>
          </div>
          <button onclick="exportSwatches()">Download</button>
        </div>
        <div class="export-option">
          <div>
            <strong>GIMP GPL</strong><br>
            <span>GIMP, Inkscape, Krita</span>
          </div>
          <button onclick="exportGPL()">Download</button>
        </div>
        <div class="export-option">
          <div>
            <strong>HEX File</strong><br>
            <span>Text list of hex codes</span>
          </div>
          <button onclick="exportHex()">Download</button>
        </div>
        <div class="export-option">
          <div>
            <strong>JSON</strong><br>
            <span>For scripts and code</span>
          </div>
          <button onclick="exportJSON()">Download</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Batch Edit Popup -->
  <div class="popup-overlay" id="batchEditPopup">
    <div class="popup" style="min-width: 340px;">
      <div class="popup-header">
        <span class="popup-title">Batch Adjust</span>
        <button class="close-btn" onclick="closeBatchEdit()">&times;</button>
      </div>
      <div class="batch-preview-row" id="batchPreviewRow"></div>
      <div class="hsl-sliders">
        <div class="slider-row">
          <label>H</label>
          <input type="range" id="batchHueSlider" min="-180" max="180" value="0">
          <span id="batchHueValue">0°</span>
        </div>
        <div class="slider-row">
          <label>S</label>
          <input type="range" id="batchSatSlider" min="-100" max="100" value="0">
          <span id="batchSatValue">0%</span>
        </div>
        <div class="slider-row">
          <label>L</label>
          <input type="range" id="batchLightSlider" min="-100" max="100" value="0">
          <span id="batchLightValue">0%</span>
        </div>
      </div>
      <div class="popup-actions" style="display:flex; gap:8px; justify-content:flex-end; margin-top:16px;">
        <button onclick="closeBatchEdit()">Cancel</button>
        <button style="background:#6c63ff;" onclick="applyBatchEdit()">Apply</button>
      </div>
    </div>
  </div>

  <script>
    // Color Names Dictionary (from Wikipedia)
    const COLOR_NAMES = [{"name":"Absolute Zero","hex":"#0048BA"},{"name":"Acid green","hex":"#B0BF1A"},{"name":"Aero","hex":"#00B9E8"},{"name":"African violet","hex":"#B284BE"},{"name":"Air superiority blue","hex":"#72A0C1"},{"name":"Alabaster","hex":"#F2F0E6"},{"name":"Alice blue","hex":"#F0F8FF"},{"name":"Alizarin","hex":"#DB2D43"},{"name":"Alloy orange","hex":"#C46210"},{"name":"Almond","hex":"#EFDECD"},{"name":"Amaranth","hex":"#E52B50"},{"name":"Amazon","hex":"#3B7A57"},{"name":"Amber","hex":"#FFBF00"},{"name":"Amethyst","hex":"#9966CC"},{"name":"Antique brass","hex":"#CD9575"},{"name":"Antique bronze","hex":"#665D1E"},{"name":"Antique fuchsia","hex":"#915C83"},{"name":"Antique ruby","hex":"#841B2D"},{"name":"Antique white","hex":"#FAEBD7"},{"name":"Apricot","hex":"#FBCEB1"},{"name":"Aqua","hex":"#00FFFF"},{"name":"Aquamarine","hex":"#7FFFD4"},{"name":"Arctic lime","hex":"#D0FF14"},{"name":"Artichoke green","hex":"#4B6F44"},{"name":"Ash gray","hex":"#B2BEB5"},{"name":"Asparagus","hex":"#7BA05B"},{"name":"Atomic tangerine","hex":"#FF9966"},{"name":"Aureolin","hex":"#FDEE00"},{"name":"Aztec gold","hex":"#C39953"},{"name":"Azure","hex":"#007FFF"},{"name":"Baby blue","hex":"#89CFF0"},{"name":"Baby pink","hex":"#F4C2C2"},{"name":"Baby powder","hex":"#FEFEFA"},{"name":"Banana","hex":"#FAE7B5"},{"name":"Barbie pink","hex":"#E0218A"},{"name":"Barn red","hex":"#7C0A02"},{"name":"Battleship gray","hex":"#848482"},{"name":"Beau blue","hex":"#BCD4E6"},{"name":"Beaver","hex":"#9F8170"},{"name":"Beige","hex":"#F5F5DC"},{"name":"Bisque","hex":"#FFE4C4"},{"name":"Bitter lemon","hex":"#CAE00D"},{"name":"Bittersweet","hex":"#FE6F5E"},{"name":"Black","hex":"#000000"},{"name":"Black bean","hex":"#3D0C02"},{"name":"Black coral","hex":"#54626F"},{"name":"Black olive","hex":"#3B3C36"},{"name":"Blanched almond","hex":"#FFEBCD"},{"name":"Bleu de France","hex":"#318CE7"},{"name":"Blizzard blue","hex":"#50BFE6"},{"name":"Blood red","hex":"#660000"},{"name":"Blue","hex":"#0000FF"},{"name":"Blue bell","hex":"#A2A2D0"},{"name":"Blue-gray","hex":"#6699CC"},{"name":"Blue-green","hex":"#0D98BA"},{"name":"Blue jeans","hex":"#5DADEC"},{"name":"Blue sapphire","hex":"#126180"},{"name":"Blue-violet","hex":"#8A2BE2"},{"name":"Blueberry","hex":"#4F86F7"},{"name":"Blush","hex":"#DE5D83"},{"name":"Bole","hex":"#79443B"},{"name":"Bone","hex":"#E3DAC9"},{"name":"Brick red","hex":"#CB4154"},{"name":"Bright green","hex":"#66FF00"},{"name":"Bright lilac","hex":"#D891EF"},{"name":"Bright maroon","hex":"#C32148"},{"name":"Bright navy blue","hex":"#1974D2"},{"name":"Bright pink","hex":"#FF007F"},{"name":"Bright turquoise","hex":"#08E8DE"},{"name":"Brilliant rose","hex":"#E667CE"},{"name":"Brink pink","hex":"#FB607F"},{"name":"British racing green","hex":"#004225"},{"name":"Bronze","hex":"#CD7F32"},{"name":"Brown","hex":"#964B00"},{"name":"Brown sugar","hex":"#AF6E4D"},{"name":"Bud green","hex":"#7BB661"},{"name":"Buff","hex":"#F0DC82"},{"name":"Burgundy","hex":"#800020"},{"name":"Burlywood","hex":"#DEB887"},{"name":"Burnt orange","hex":"#CC5500"},{"name":"Burnt sienna","hex":"#E97451"},{"name":"Burnt umber","hex":"#8A3324"},{"name":"Byzantine","hex":"#BD33A4"},{"name":"Byzantium","hex":"#702963"},{"name":"Cadet","hex":"#536872"},{"name":"Cadet blue","hex":"#5F9EA0"},{"name":"Cadet gray","hex":"#91A3B0"},{"name":"Cadmium green","hex":"#006B3C"},{"name":"Cadmium orange","hex":"#ED872D"},{"name":"Cadmium red","hex":"#E30022"},{"name":"Cadmium yellow","hex":"#FFF600"},{"name":"Cafe au lait","hex":"#A67B5B"},{"name":"Cafe noir","hex":"#4B3621"},{"name":"Cambridge blue","hex":"#A3C1AD"},{"name":"Camel","hex":"#C19A6B"},{"name":"Cameo pink","hex":"#EFBBCC"},{"name":"Canary","hex":"#FFFF99"},{"name":"Canary yellow","hex":"#FFEF00"},{"name":"Candy apple red","hex":"#FF0800"},{"name":"Candy pink","hex":"#E4717A"},{"name":"Cardinal","hex":"#C41E3A"},{"name":"Caribbean green","hex":"#00CC99"},{"name":"Carmine","hex":"#960018"},{"name":"Carnation pink","hex":"#FFA6C9"},{"name":"Carolina blue","hex":"#56A0D3"},{"name":"Carrot orange","hex":"#ED9121"},{"name":"Catawba","hex":"#703642"},{"name":"Cedar Chest","hex":"#CA3435"},{"name":"Celadon","hex":"#ACE1AF"},{"name":"Celeste","hex":"#B2FFFF"},{"name":"Cerise","hex":"#DE3163"},{"name":"Cerulean","hex":"#007BA7"},{"name":"Cerulean blue","hex":"#2A52BE"},{"name":"Champagne","hex":"#F7E7CE"},{"name":"Charcoal","hex":"#36454F"},{"name":"Charleston green","hex":"#232B2B"},{"name":"Charm pink","hex":"#E68FAC"},{"name":"Chartreuse","hex":"#7FFF00"},{"name":"Cherry blossom pink","hex":"#FFB7C5"},{"name":"Chestnut","hex":"#954535"},{"name":"China pink","hex":"#DE6FA1"},{"name":"Chinese red","hex":"#AA381E"},{"name":"Chinese violet","hex":"#856088"},{"name":"Chocolate","hex":"#7B3F00"},{"name":"Cinnamon","hex":"#D2691E"},{"name":"Citrine","hex":"#E4D00A"},{"name":"Citron","hex":"#9FA91F"},{"name":"Claret","hex":"#7F1734"},{"name":"Cobalt blue","hex":"#0047AB"},{"name":"Cocoa brown","hex":"#D2691E"},{"name":"Coconut","hex":"#965A3E"},{"name":"Coffee","hex":"#6F4E37"},{"name":"Columbia Blue","hex":"#C4D8E2"},{"name":"Congo pink","hex":"#F88379"},{"name":"Cool gray","hex":"#8C92AC"},{"name":"Copper","hex":"#B87333"},{"name":"Copper penny","hex":"#AD6F69"},{"name":"Copper red","hex":"#CB6D51"},{"name":"Copper rose","hex":"#996666"},{"name":"Coquelicot","hex":"#FF3800"},{"name":"Coral","hex":"#FF7F50"},{"name":"Coral pink","hex":"#F88379"},{"name":"Cordovan","hex":"#893F45"},{"name":"Cornflower blue","hex":"#6495ED"},{"name":"Cornsilk","hex":"#FFF8DC"},{"name":"Cosmic latte","hex":"#FFF8E7"},{"name":"Cotton candy","hex":"#FFBCD9"},{"name":"Cream","hex":"#FFFDD0"},{"name":"Crimson","hex":"#DC143C"},{"name":"Cyan","hex":"#00FFFF"},{"name":"Cyber grape","hex":"#58427C"},{"name":"Cyber yellow","hex":"#FFD300"},{"name":"Cyclamen","hex":"#F56FA1"},{"name":"Dandelion","hex":"#DDF719"},{"name":"Dark blue","hex":"#00008B"},{"name":"Dark brown","hex":"#654321"},{"name":"Dark cyan","hex":"#008B8B"},{"name":"Dark goldenrod","hex":"#B8860B"},{"name":"Dark gray","hex":"#A9A9A9"},{"name":"Dark green","hex":"#013220"},{"name":"Dark jungle green","hex":"#1A2421"},{"name":"Dark khaki","hex":"#BDB76B"},{"name":"Dark lava","hex":"#483C32"},{"name":"Dark magenta","hex":"#8B008B"},{"name":"Dark midnight blue","hex":"#003366"},{"name":"Dark moss green","hex":"#4A5D23"},{"name":"Dark olive green","hex":"#556B2F"},{"name":"Dark orange","hex":"#FF8C00"},{"name":"Dark orchid","hex":"#9932CC"},{"name":"Dark pastel green","hex":"#03C03C"},{"name":"Dark raspberry","hex":"#872657"},{"name":"Dark red","hex":"#8B0000"},{"name":"Dark salmon","hex":"#E9967A"},{"name":"Dark sea green","hex":"#8FBC8F"},{"name":"Dark sienna","hex":"#3C1414"},{"name":"Dark sky blue","hex":"#8CBED6"},{"name":"Dark slate blue","hex":"#483D8B"},{"name":"Dark slate gray","hex":"#2F4F4F"},{"name":"Dark spring green","hex":"#177245"},{"name":"Dark tan","hex":"#918151"},{"name":"Dark turquoise","hex":"#00CED1"},{"name":"Dark vanilla","hex":"#D1BEA8"},{"name":"Dark violet","hex":"#9400D3"},{"name":"Dartmouth green","hex":"#00703C"},{"name":"Davy's gray","hex":"#555555"},{"name":"Deep cerise","hex":"#DA3287"},{"name":"Deep champagne","hex":"#FAD6A5"},{"name":"Deep chestnut","hex":"#B94E48"},{"name":"Deep fuchsia","hex":"#C154C1"},{"name":"Deep jungle green","hex":"#004B49"},{"name":"Deep lemon","hex":"#F5C71A"},{"name":"Deep mauve","hex":"#D473D4"},{"name":"Deep pink","hex":"#FF1493"},{"name":"Deep sky blue","hex":"#00BFFF"},{"name":"Deep taupe","hex":"#7E5E60"},{"name":"Denim","hex":"#1560BD"},{"name":"Denim blue","hex":"#2243B6"},{"name":"Desert","hex":"#C19A6B"},{"name":"Desert sand","hex":"#EDC9AF"},{"name":"Dim gray","hex":"#696969"},{"name":"Dirt","hex":"#9B7653"},{"name":"Dodger blue","hex":"#1E90FF"},{"name":"Dogwood rose","hex":"#D71868"},{"name":"Duke blue","hex":"#00009C"},{"name":"Dutch white","hex":"#EFDFBB"},{"name":"Earth yellow","hex":"#E1A95F"},{"name":"Ebony","hex":"#555D50"},{"name":"Ecru","hex":"#C2B280"},{"name":"Eerie black","hex":"#1B1B1B"},{"name":"Eggplant","hex":"#614051"},{"name":"Eggshell","hex":"#F0EAD6"},{"name":"Egyptian blue","hex":"#1034A6"},{"name":"Electric blue","hex":"#7DF9FF"},{"name":"Electric indigo","hex":"#6F00FF"},{"name":"Electric lime","hex":"#CCFF00"},{"name":"Electric purple","hex":"#BF00FF"},{"name":"Electric violet","hex":"#8F00FF"},{"name":"Emerald","hex":"#50C878"},{"name":"Eminence","hex":"#6C3082"},{"name":"English lavender","hex":"#B48395"},{"name":"English red","hex":"#AB4B52"},{"name":"English violet","hex":"#563C5C"},{"name":"Erin","hex":"#00FF40"},{"name":"Eton blue","hex":"#96C8A2"},{"name":"Eucalyptus","hex":"#44D7A8"},{"name":"Fallow","hex":"#C19A6B"},{"name":"Falu red","hex":"#801818"},{"name":"Fandango","hex":"#B53389"},{"name":"Fandango pink","hex":"#DE5285"},{"name":"Fashion fuchsia","hex":"#F400A1"},{"name":"Fawn","hex":"#E5AA70"},{"name":"Feldgrau","hex":"#4D5D53"},{"name":"Fern green","hex":"#4F7942"},{"name":"Field drab","hex":"#6C541E"},{"name":"Fiery rose","hex":"#FF5470"},{"name":"Firebrick","hex":"#B22222"},{"name":"Fire engine red","hex":"#CE2029"},{"name":"Fire opal","hex":"#E95C4B"},{"name":"Flame","hex":"#E25822"},{"name":"Flax","hex":"#EEDC82"},{"name":"Flirt","hex":"#A2006D"},{"name":"Floral white","hex":"#FFFAF0"},{"name":"Forest green","hex":"#228B22"},{"name":"French beige","hex":"#A67B5B"},{"name":"French blue","hex":"#0072BB"},{"name":"French fuchsia","hex":"#FD3F92"},{"name":"French lilac","hex":"#86608E"},{"name":"French lime","hex":"#9EFD38"},{"name":"French mauve","hex":"#D473D4"},{"name":"French pink","hex":"#FD6C9E"},{"name":"French raspberry","hex":"#C72C48"},{"name":"French rose","hex":"#F64A8A"},{"name":"French sky blue","hex":"#77B5FE"},{"name":"French violet","hex":"#8806CE"},{"name":"Frostbite","hex":"#E936A7"},{"name":"Fuchsia","hex":"#FF00FF"},{"name":"Fuchsia purple","hex":"#CC397B"},{"name":"Fuchsia rose","hex":"#C74375"},{"name":"Fulvous","hex":"#E48400"},{"name":"Fuzzy Wuzzy","hex":"#87421F"},{"name":"Gainsboro","hex":"#DCDCDC"},{"name":"Gamboge","hex":"#E49B0F"},{"name":"Garnet","hex":"#733635"},{"name":"Ghost white","hex":"#F8F8FF"},{"name":"Glaucous","hex":"#6082B6"},{"name":"Gold","hex":"#FFD700"},{"name":"Gold metallic","hex":"#D4AF37"},{"name":"Golden brown","hex":"#996515"},{"name":"Golden poppy","hex":"#FCC200"},{"name":"Golden yellow","hex":"#FFDF00"},{"name":"Goldenrod","hex":"#DAA520"},{"name":"Granite gray","hex":"#676767"},{"name":"Granny Smith apple","hex":"#A8E4A0"},{"name":"Grape","hex":"#6F2DA8"},{"name":"Gray","hex":"#808080"},{"name":"Green","hex":"#00FF00"},{"name":"Green-blue","hex":"#1164B4"},{"name":"Green-cyan","hex":"#009966"},{"name":"Green-yellow","hex":"#ADFF2F"},{"name":"Grullo","hex":"#A99A86"},{"name":"Gunmetal","hex":"#2A3439"},{"name":"Han blue","hex":"#446CCF"},{"name":"Han purple","hex":"#5218FA"},{"name":"Harlequin","hex":"#3FFF00"},{"name":"Harvest gold","hex":"#DA9100"},{"name":"Heat Wave","hex":"#FF7A00"},{"name":"Heliotrope","hex":"#DF73FF"},{"name":"Heliotrope gray","hex":"#AA98A9"},{"name":"Hollywood cerise","hex":"#F400A1"},{"name":"Honeydew","hex":"#F0FFF0"},{"name":"Honolulu blue","hex":"#006DB0"},{"name":"Hooker's green","hex":"#49796B"},{"name":"Hot fuchsia","hex":"#FF00C6"},{"name":"Hot pink","hex":"#FF69B4"},{"name":"Hunter green","hex":"#355E3B"},{"name":"Iceberg","hex":"#71A6D2"},{"name":"Icterine","hex":"#FCF75E"},{"name":"Imperial red","hex":"#ED2939"},{"name":"Inchworm","hex":"#B2EC5D"},{"name":"Independence","hex":"#4C516D"},{"name":"India green","hex":"#138808"},{"name":"Indian red","hex":"#CD5C5C"},{"name":"Indian yellow","hex":"#E3A857"},{"name":"Indigo","hex":"#4B0082"},{"name":"Indigo dye","hex":"#00416A"},{"name":"Iris","hex":"#5A4FCF"},{"name":"Irresistible","hex":"#B3446C"},{"name":"Isabelline","hex":"#F4F0EC"},{"name":"Italian sky blue","hex":"#B2FFFF"},{"name":"Ivory","hex":"#FFFFF0"},{"name":"Jade","hex":"#00A86B"},{"name":"Japanese carmine","hex":"#9D2933"},{"name":"Japanese violet","hex":"#5B3256"},{"name":"Jasmine","hex":"#F8DE7E"},{"name":"Jazzberry jam","hex":"#A50B5E"},{"name":"Jet","hex":"#343434"},{"name":"Jonquil","hex":"#F4CA16"},{"name":"June bud","hex":"#BDDA57"},{"name":"Jungle green","hex":"#29AB87"},{"name":"Kelly green","hex":"#4CBB17"},{"name":"Keppel","hex":"#3AB09E"},{"name":"Key lime","hex":"#E8F48C"},{"name":"Khaki","hex":"#C3B091"},{"name":"Kobe","hex":"#882D17"},{"name":"Kobi","hex":"#E79FC4"},{"name":"Kobicha","hex":"#6B4423"},{"name":"Kombu green","hex":"#354230"},{"name":"La Salle green","hex":"#087830"},{"name":"Languid lavender","hex":"#D6CADD"},{"name":"Lapis lazuli","hex":"#26619C"},{"name":"Laser Lemon","hex":"#FFFF66"},{"name":"Laurel green","hex":"#A9BA9D"},{"name":"Lava","hex":"#CF1020"},{"name":"Lavender floral","hex":"#B57EDC"},{"name":"Lavender web","hex":"#E6E6FA"},{"name":"Lavender blue","hex":"#CCCCFF"},{"name":"Lavender gray","hex":"#C4C3D0"},{"name":"Lavender indigo","hex":"#9457EB"},{"name":"Lavender magenta","hex":"#EE82EE"},{"name":"Lavender purple","hex":"#967BB6"},{"name":"Lavender rose","hex":"#FBA0E3"},{"name":"Lemon","hex":"#FFF700"},{"name":"Lemon chiffon","hex":"#FFFACD"},{"name":"Lemon curry","hex":"#CCA01D"},{"name":"Lemon glacier","hex":"#FDFF00"},{"name":"Lemon lime","hex":"#E3FF00"},{"name":"Lemon meringue","hex":"#F6EABE"},{"name":"Lemon yellow","hex":"#FFF44F"},{"name":"Licorice","hex":"#1A1110"},{"name":"Light brown","hex":"#B5651D"},{"name":"Light carmine pink","hex":"#E66771"},{"name":"Light cobalt blue","hex":"#88ACE0"},{"name":"Light cornflower blue","hex":"#93CCEA"},{"name":"Light crimson","hex":"#F56991"},{"name":"Light cyan","hex":"#E0FFFF"},{"name":"Light French beige","hex":"#C8AD7F"},{"name":"Light fuchsia pink","hex":"#F984EF"},{"name":"Light gold","hex":"#B29700"},{"name":"Light Moss Green","hex":"#ADDFAD"},{"name":"Light orchid","hex":"#E6A8D7"},{"name":"Light pastel purple","hex":"#B19CD9"},{"name":"Light periwinkle","hex":"#C5CBE1"},{"name":"Light red","hex":"#FFCCCB"},{"name":"Light salmon pink","hex":"#FF9999"},{"name":"Light sea green","hex":"#20B2AA"},{"name":"Light silver","hex":"#D8D8D8"},{"name":"Lilac","hex":"#C8A2C8"},{"name":"Lime","hex":"#BFFF00"},{"name":"Lime green","hex":"#32CD32"},{"name":"Limerick","hex":"#9DC209"},{"name":"Lincoln green","hex":"#195905"},{"name":"Linen","hex":"#FAF0E6"},{"name":"Lion","hex":"#C19A6B"},{"name":"Little boy blue","hex":"#6CA0DC"},{"name":"Little girl pink","hex":"#F8B9D4"},{"name":"Liver","hex":"#674C47"},{"name":"Livid","hex":"#6699CC"},{"name":"Lumber","hex":"#FFE4CD"},{"name":"Lust","hex":"#E62020"},{"name":"Macaroni and Cheese","hex":"#FFBD88"},{"name":"Madder Lake","hex":"#CC3336"},{"name":"Magenta","hex":"#FF00FF"},{"name":"Magic Mint","hex":"#AAF0D1"},{"name":"Mahogany","hex":"#C04000"},{"name":"Maize","hex":"#FBEC5D"},{"name":"Majorelle Blue","hex":"#6050DC"},{"name":"Malachite","hex":"#0BDA51"},{"name":"Manatee","hex":"#979AAA"},{"name":"Mandarin","hex":"#F37A48"},{"name":"Mango","hex":"#FDBE02"},{"name":"Mango Tango","hex":"#FF8243"},{"name":"Mantis","hex":"#74C365"},{"name":"Mardi Gras","hex":"#880085"},{"name":"Marigold","hex":"#EAA221"},{"name":"Maroon","hex":"#800000"},{"name":"Mauve","hex":"#E0B0FF"},{"name":"Mauve taupe","hex":"#915F6D"},{"name":"Mauvelous","hex":"#EF98AA"},{"name":"Maximum Blue","hex":"#47ABCC"},{"name":"Maximum Green","hex":"#5E8C31"},{"name":"Maximum orange","hex":"#FF5B00"},{"name":"Maximum Purple","hex":"#733380"},{"name":"Maximum pink","hex":"#F6A5F2"},{"name":"Maximum red","hex":"#D92121"},{"name":"Maximum violet","hex":"#892F77"},{"name":"Maximum yellow","hex":"#FAFA37"},{"name":"May green","hex":"#4C9141"},{"name":"Maya blue","hex":"#73C2FB"},{"name":"Medium aquamarine","hex":"#66DDAA"},{"name":"Medium blue","hex":"#0000CD"},{"name":"Medium candy apple red","hex":"#E2062C"},{"name":"Medium carmine","hex":"#AF4035"},{"name":"Medium champagne","hex":"#F3E5AB"},{"name":"Medium electric blue","hex":"#035096"},{"name":"Medium green","hex":"#037949"},{"name":"Medium jungle green","hex":"#1C352D"},{"name":"Medium lavender magenta","hex":"#DDA0DD"},{"name":"Medium orange","hex":"#FF7802"},{"name":"Medium orchid","hex":"#BA55D3"},{"name":"Medium Persian blue","hex":"#0067A5"},{"name":"Medium pink","hex":"#FE6E9F"},{"name":"Medium purple","hex":"#9370DB"},{"name":"Medium red","hex":"#B10304"},{"name":"Medium red-violet","hex":"#BB3385"},{"name":"Medium ruby","hex":"#AA4069"},{"name":"Medium sea green","hex":"#3CB371"},{"name":"Medium sky blue","hex":"#80DAEB"},{"name":"Medium slate blue","hex":"#7B68EE"},{"name":"Medium spring bud","hex":"#C9DC87"},{"name":"Medium spring green","hex":"#00FA9A"},{"name":"Medium taupe","hex":"#674C47"},{"name":"Medium turquoise","hex":"#48D1CC"},{"name":"Medium vermilion","hex":"#D9603B"},{"name":"Medium violet","hex":"#65315F"},{"name":"Medium violet-red","hex":"#C71585"},{"name":"Medium yellow","hex":"#FFE302"},{"name":"Mellow apricot","hex":"#F8B878"},{"name":"Mellow yellow","hex":"#F8DE7E"},{"name":"Melon","hex":"#FDBCB4"},{"name":"Menthol","hex":"#C1F9A2"},{"name":"Metallic blue","hex":"#32527B"},{"name":"Metallic bronze","hex":"#A97142"},{"name":"Metallic brown","hex":"#AC4313"},{"name":"Metallic gold","hex":"#D3AF37"},{"name":"Metallic green","hex":"#296E01"},{"name":"Metallic orange","hex":"#DA680F"},{"name":"Metallic pink","hex":"#EDA6C4"},{"name":"Metallic red","hex":"#A62C2B"},{"name":"Metallic Seaweed","hex":"#0A7E8C"},{"name":"Metallic silver","hex":"#A8A9AD"},{"name":"Metallic violet","hex":"#5B0A91"},{"name":"Metallic yellow","hex":"#FDCC0D"},{"name":"Mexican pink","hex":"#E4007C"},{"name":"Middle blue","hex":"#7ED4E6"},{"name":"Middle blue green","hex":"#8DD9CC"},{"name":"Middle blue purple","hex":"#8B72BE"},{"name":"Middle gray","hex":"#8B8680"},{"name":"Middle green","hex":"#4D8C57"},{"name":"Middle green yellow","hex":"#ACBF60"},{"name":"Middle purple","hex":"#D982B5"},{"name":"Middle red","hex":"#E58E73"},{"name":"Middle red purple","hex":"#A55353"},{"name":"Middle violet","hex":"#8F00FF"},{"name":"Middle yellow","hex":"#FFEB00"},{"name":"Middle yellow red","hex":"#ECB176"},{"name":"Midnight","hex":"#702670"},{"name":"Midnight blue","hex":"#191970"},{"name":"Mikado yellow","hex":"#FFC40C"},{"name":"Milk","hex":"#FDFFF5"},{"name":"Milk chocolate","hex":"#84563C"},{"name":"Mimi pink","hex":"#FFDAE9"},{"name":"Mindaro","hex":"#E3F988"},{"name":"Ming","hex":"#36747D"},{"name":"Minion yellow","hex":"#F5E050"},{"name":"Mint","hex":"#3EB489"},{"name":"Mint cream","hex":"#F5FFFA"},{"name":"Mint green","hex":"#98FF98"},{"name":"Misty Moss","hex":"#BBB477"},{"name":"Misty rose","hex":"#FFE4E1"},{"name":"Moccasin","hex":"#FAEBD7"},{"name":"Mocha","hex":"#BEA493"},{"name":"Mode beige","hex":"#967117"},{"name":"Moonstone","hex":"#3AA8C1"},{"name":"Moonstone blue","hex":"#73A9C2"},{"name":"Morning blue","hex":"#8DA399"},{"name":"Moss green","hex":"#8A9A5B"},{"name":"Mountain Meadow","hex":"#30BA8F"},{"name":"Mountbatten pink","hex":"#997A8D"},{"name":"Mud","hex":"#70543E"},{"name":"Mughal green","hex":"#306030"},{"name":"Mulberry","hex":"#C54B8C"},{"name":"Mustard","hex":"#FFDB58"},{"name":"Mustard brown","hex":"#CD7A00"},{"name":"Mustard green","hex":"#6E6E30"},{"name":"Mustard yellow","hex":"#E1AD01"},{"name":"Myrtle green","hex":"#317873"},{"name":"Mystic","hex":"#D65282"},{"name":"Mystic maroon","hex":"#AD4379"},{"name":"Nadeshiko pink","hex":"#F6ADC6"},{"name":"Napier green","hex":"#2A8000"},{"name":"Naples yellow","hex":"#FADA5E"},{"name":"Navajo white","hex":"#FFDEAD"},{"name":"Navy blue","hex":"#000080"},{"name":"Neon blue","hex":"#1B03A3"},{"name":"Neon brown","hex":"#C3732A"},{"name":"Neon Carrot","hex":"#FF9933"},{"name":"Neon cyan","hex":"#00FEFC"},{"name":"Neon fuchsia","hex":"#FE4164"},{"name":"Neon gold","hex":"#CFAA01"},{"name":"Neon gray","hex":"#808080"},{"name":"Neon dark green","hex":"#008443"},{"name":"Neon green","hex":"#139B42"},{"name":"Neon pink","hex":"#FE347E"},{"name":"Neon purple","hex":"#9457EB"},{"name":"Neon red","hex":"#FF1818"},{"name":"Neon scarlet","hex":"#FF2603"},{"name":"Neon silver","hex":"#CCCCCC"},{"name":"Neon tangerine","hex":"#F6890A"},{"name":"Neon yellow","hex":"#FFF700"},{"name":"New York pink","hex":"#D7837F"},{"name":"Nickel","hex":"#727472"},{"name":"Non-photo blue","hex":"#A4DDED"},{"name":"Nyanza","hex":"#E9FFDB"},{"name":"Ocean boat blue","hex":"#0077BE"},{"name":"Ocher","hex":"#CC7722"},{"name":"Old burgundy","hex":"#43302E"},{"name":"Old gold","hex":"#CFB53B"},{"name":"Old lace","hex":"#FDF5E6"},{"name":"Old lavender","hex":"#796878"},{"name":"Old mauve","hex":"#673147"},{"name":"Old moss green","hex":"#867E36"},{"name":"Old rose","hex":"#C08081"},{"name":"Old silver","hex":"#848482"},{"name":"Olive","hex":"#808000"},{"name":"Olive drab","hex":"#6B8E23"},{"name":"Olive green","hex":"#B5B35C"},{"name":"Olivine","hex":"#9AB973"},{"name":"Onyx","hex":"#353839"},{"name":"Opal","hex":"#A8C3BC"},{"name":"Opera mauve","hex":"#B784A7"},{"name":"Orange","hex":"#FF7F00"},{"name":"Orange-red","hex":"#FF5349"},{"name":"Orange soda","hex":"#E74E14"},{"name":"Orange-yellow","hex":"#F5BD1F"},{"name":"Orchid","hex":"#DA70D6"},{"name":"Orchid pink","hex":"#F2BDCD"},{"name":"Orioles orange","hex":"#FB4F14"},{"name":"Otter brown","hex":"#654321"},{"name":"Outer Space","hex":"#414A4C"},{"name":"Outrageous orange","hex":"#FF6037"},{"name":"Oxblood","hex":"#800020"},{"name":"Oxford blue","hex":"#002147"},{"name":"Pacific Blue","hex":"#1CA9C9"},{"name":"Pakistan green","hex":"#006600"},{"name":"Palatinate blue","hex":"#273BE2"},{"name":"Palatinate purple","hex":"#682860"},{"name":"Pale aqua","hex":"#BCD4E6"},{"name":"Pale blue","hex":"#AFEEEE"},{"name":"Pale brown","hex":"#987654"},{"name":"Pale carmine","hex":"#AF4035"},{"name":"Pale cerulean","hex":"#9BC4E2"},{"name":"Pale chestnut","hex":"#DDADAF"},{"name":"Pale copper","hex":"#DA8A67"},{"name":"Pale cornflower blue","hex":"#ABCDEF"},{"name":"Pale cyan","hex":"#87D3F8"},{"name":"Pale gold","hex":"#E6BE8A"},{"name":"Pale goldenrod","hex":"#EEE8AA"},{"name":"Pale green","hex":"#98FB98"},{"name":"Pale lavender","hex":"#DCD0FF"},{"name":"Pale pink","hex":"#FADADD"},{"name":"Pale plum","hex":"#DDA0DD"},{"name":"Pale robin egg blue","hex":"#96DED1"},{"name":"Pale silver","hex":"#C9C0BB"},{"name":"Pale spring bud","hex":"#ECEBBD"},{"name":"Pale taupe","hex":"#BC987E"},{"name":"Pale turquoise","hex":"#AFEEEE"},{"name":"Pale violet","hex":"#CC99FF"},{"name":"Pale violet-red","hex":"#DB7093"},{"name":"Pansy purple","hex":"#78184A"},{"name":"Papaya whip","hex":"#FFEFD5"},{"name":"Paradise pink","hex":"#E63E62"},{"name":"Parchment","hex":"#F1E9D2"},{"name":"Paris Green","hex":"#50C878"},{"name":"Pastel blue","hex":"#AEC6CF"},{"name":"Pastel brown","hex":"#836953"},{"name":"Pastel gray","hex":"#CFCFC4"},{"name":"Pastel green","hex":"#77DD77"},{"name":"Pastel magenta","hex":"#F49AC2"},{"name":"Pastel orange","hex":"#FFB347"},{"name":"Pastel pink","hex":"#DEA5A4"},{"name":"Pastel purple","hex":"#B39EB5"},{"name":"Pastel red","hex":"#FF6961"},{"name":"Pastel violet","hex":"#CB99C9"},{"name":"Pastel yellow","hex":"#FDFD96"},{"name":"Patriarch","hex":"#800080"},{"name":"Payne's gray","hex":"#536878"},{"name":"Peach","hex":"#FFE5B4"},{"name":"Peach puff","hex":"#FFDAB9"},{"name":"Pear","hex":"#D1E231"},{"name":"Pearl","hex":"#EAE0C8"},{"name":"Pearl Aqua","hex":"#88D8C0"},{"name":"Pearly purple","hex":"#B768A2"},{"name":"Peridot","hex":"#E6E200"},{"name":"Periwinkle","hex":"#CCCCFF"},{"name":"Persian blue","hex":"#1C39BB"},{"name":"Persian green","hex":"#00A693"},{"name":"Persian indigo","hex":"#32127A"},{"name":"Persian orange","hex":"#D99058"},{"name":"Persian pink","hex":"#F77FBE"},{"name":"Persian plum","hex":"#701C1C"},{"name":"Persian red","hex":"#CC3333"},{"name":"Persian rose","hex":"#FE28A2"},{"name":"Persimmon","hex":"#EC5800"},{"name":"Peru","hex":"#CD853F"},{"name":"Petal","hex":"#F5E2E2"},{"name":"Pewter blue","hex":"#8BA8B7"},{"name":"Philippine blue","hex":"#0038A7"},{"name":"Philippine bronze","hex":"#6E3A07"},{"name":"Philippine brown","hex":"#5D1916"},{"name":"Philippine gold","hex":"#B17304"},{"name":"Philippine golden yellow","hex":"#FFDF00"},{"name":"Philippine gray","hex":"#8C8C8C"},{"name":"Philippine green","hex":"#008543"},{"name":"Philippine orange","hex":"#FF7300"},{"name":"Philippine pink","hex":"#FA1A8E"},{"name":"Philippine red","hex":"#CE1127"},{"name":"Philippine silver","hex":"#B3B3B3"},{"name":"Philippine sky blue","hex":"#0066FF"},{"name":"Philippine violet","hex":"#81007F"},{"name":"Philippine yellow","hex":"#FECB00"},{"name":"Phlox","hex":"#DF00FF"},{"name":"Phthalo blue","hex":"#000F89"},{"name":"Phthalo green","hex":"#123524"},{"name":"Picton blue","hex":"#45B1E8"},{"name":"Pictorial carmine","hex":"#C30B4E"},{"name":"Piggy pink","hex":"#FDDDE6"},{"name":"Pine green","hex":"#01796F"},{"name":"Pineapple","hex":"#563C0D"},{"name":"Pink","hex":"#FFC0CB"},{"name":"Pink Diamond","hex":"#F6D6DE"},{"name":"Pink flamingo","hex":"#FC74FD"},{"name":"Pink lace","hex":"#FFDDF4"},{"name":"Pink pearl","hex":"#E7ACCF"},{"name":"Pink Sherbet","hex":"#F78FA7"},{"name":"Pistachio","hex":"#93C572"},{"name":"Platinum","hex":"#E5E4E2"},{"name":"Plum","hex":"#8E4585"},{"name":"Plum web","hex":"#DDA0DD"},{"name":"Plump Purple","hex":"#5946B2"},{"name":"Poison Purple","hex":"#7F01FE"},{"name":"Police blue","hex":"#374F6B"},{"name":"Polished pine","hex":"#5DA493"},{"name":"Pomp and Power","hex":"#86608E"},{"name":"Portland Orange","hex":"#FF5A36"},{"name":"Powder blue","hex":"#B0E0E6"},{"name":"Princeton orange","hex":"#F58025"},{"name":"Prune","hex":"#701C1C"},{"name":"Prussian blue","hex":"#003153"},{"name":"Puce","hex":"#CC8899"},{"name":"Puce red","hex":"#722F37"},{"name":"Pumpkin","hex":"#FF7518"},{"name":"Purple","hex":"#800080"},{"name":"Purple Heart","hex":"#69359C"},{"name":"Purple mountain majesty","hex":"#9678B6"},{"name":"Purple navy","hex":"#4E5180"},{"name":"Purple Plum","hex":"#9C51B6"},{"name":"Purple taupe","hex":"#50404D"},{"name":"Purpureus","hex":"#9A4EAE"},{"name":"Quartz","hex":"#51484F"},{"name":"Queen blue","hex":"#436B95"},{"name":"Queen pink","hex":"#E8CCD7"},{"name":"Quick silver","hex":"#A6A6A6"},{"name":"Quinacridone magenta","hex":"#8E3A59"},{"name":"Quincy","hex":"#6A5445"},{"name":"Rackley","hex":"#5D8AA8"},{"name":"Radical Red","hex":"#FF355E"},{"name":"Raisin black","hex":"#242124"},{"name":"Rajah","hex":"#FBAB60"},{"name":"Raspberry","hex":"#E30B5D"},{"name":"Raw Sienna","hex":"#D68A59"},{"name":"Raw umber","hex":"#826644"},{"name":"Razzmatazz","hex":"#E30B5C"},{"name":"Razzle Dazzle Rose","hex":"#FF33CC"},{"name":"Razzmic Berry","hex":"#8D4E85"},{"name":"Rebecca Purple","hex":"#663399"},{"name":"Red","hex":"#FF0000"},{"name":"Red-brown","hex":"#A52A2A"},{"name":"Red cola","hex":"#DF0118"},{"name":"Red-orange","hex":"#FF681F"},{"name":"Red rum","hex":"#973A4A"},{"name":"Red Salsa","hex":"#FD3A4A"},{"name":"Red strawberry","hex":"#EC0304"},{"name":"Red-violet","hex":"#C71585"},{"name":"Redwood","hex":"#A45A52"},{"name":"Resolution blue","hex":"#002387"},{"name":"Rhythm","hex":"#777696"},{"name":"Rich brilliant lavender","hex":"#F1A7FE"},{"name":"Rich carmine","hex":"#D70040"},{"name":"Rich electric blue","hex":"#0892D0"},{"name":"Rich lavender","hex":"#A76BCF"},{"name":"Rich lilac","hex":"#B666D2"},{"name":"Rich maroon","hex":"#B03060"},{"name":"Rifle green","hex":"#444C38"},{"name":"Ripe mango","hex":"#FFC324"},{"name":"Roast coffee","hex":"#704241"},{"name":"Robin egg blue","hex":"#00CCCC"},{"name":"Rocket metallic","hex":"#8A7F80"},{"name":"Roman silver","hex":"#838996"},{"name":"Root beer","hex":"#290E05"},{"name":"Rose","hex":"#FF007F"},{"name":"Rose dust","hex":"#9E5E6F"},{"name":"Royal azure","hex":"#0038A8"},{"name":"Royal blue","hex":"#002366"},{"name":"Royal brown","hex":"#523B35"},{"name":"Royal fuchsia","hex":"#CA2C92"},{"name":"Royal green","hex":"#136207"},{"name":"Royal orange","hex":"#F99245"},{"name":"Royal pink","hex":"#E73895"},{"name":"Royal red","hex":"#9B1C31"},{"name":"Royal purple","hex":"#7851A9"},{"name":"Royal yellow","hex":"#FADA5E"},{"name":"Ruby","hex":"#E0115F"},{"name":"Rufous","hex":"#A81C07"},{"name":"Rum","hex":"#9A4E40"},{"name":"Russet","hex":"#80461B"},{"name":"Russian green","hex":"#679267"},{"name":"Russian violet","hex":"#32174D"},{"name":"Rust","hex":"#B7410E"},{"name":"Rusty red","hex":"#DA2C43"},{"name":"Sacramento State green","hex":"#043927"},{"name":"Saddle Brown","hex":"#8B4513"},{"name":"Safety orange","hex":"#FF7800"},{"name":"Safety yellow","hex":"#EED202"},{"name":"Saffron","hex":"#F4C430"},{"name":"Sage","hex":"#BCB88A"},{"name":"St. Patrick's blue","hex":"#23297A"},{"name":"Salem","hex":"#177B4D"},{"name":"Salmon","hex":"#FA8072"},{"name":"Salmon Rose","hex":"#E7968B"},{"name":"Salmon pink","hex":"#FF91A4"},{"name":"Sand","hex":"#C2B280"},{"name":"Sand dune","hex":"#967117"},{"name":"Sandy brown","hex":"#F4A460"},{"name":"Sandy taupe","hex":"#967117"},{"name":"Sap green","hex":"#507D2A"},{"name":"Sapphire","hex":"#0F52BA"},{"name":"Sapphire blue","hex":"#0067A5"},{"name":"Satin sheen gold","hex":"#CBA135"},{"name":"Savoy blue","hex":"#4B61D1"},{"name":"Scarlet","hex":"#FF2400"},{"name":"Schauss pink","hex":"#FF91AF"},{"name":"School bus yellow","hex":"#FFD800"},{"name":"Screamin' green","hex":"#66FF66"},{"name":"Sea blue","hex":"#006994"},{"name":"Sea green","hex":"#2E8B57"},{"name":"Seal brown","hex":"#59260B"},{"name":"Seashell","hex":"#FFF5EE"},{"name":"Selective yellow","hex":"#FFBA00"},{"name":"Sepia","hex":"#704214"},{"name":"Shadow","hex":"#8A795D"},{"name":"Shadow blue","hex":"#778BA5"},{"name":"Shampoo","hex":"#FFCFF1"},{"name":"Shamrock green","hex":"#009E60"},{"name":"Shandy","hex":"#FFE670"},{"name":"Sheen green","hex":"#8FD400"},{"name":"Shimmering Blush","hex":"#D98695"},{"name":"Shiny shamrock","hex":"#5FA778"},{"name":"Shocking pink","hex":"#FC0FC0"},{"name":"Sienna","hex":"#882D17"},{"name":"Silver","hex":"#C0C0C0"},{"name":"Silver chalice","hex":"#ACACAC"},{"name":"Silver foil","hex":"#AFB1AE"},{"name":"Silver Lake blue","hex":"#5D89BA"},{"name":"Silver pink","hex":"#C4AEAD"},{"name":"Silver sand","hex":"#BFC1C2"},{"name":"Sinopia","hex":"#CB410B"},{"name":"Sizzling Red","hex":"#FF3855"},{"name":"Sizzling Sunrise","hex":"#FFDB00"},{"name":"Skobeloff","hex":"#007474"},{"name":"Sky blue","hex":"#87CEEB"},{"name":"Sky magenta","hex":"#CF71AF"},{"name":"Slate blue","hex":"#6A5ACD"},{"name":"Slate gray","hex":"#708090"},{"name":"Slimy green","hex":"#299617"},{"name":"Smalt","hex":"#003399"},{"name":"Smoke","hex":"#738276"},{"name":"Smokey Topaz","hex":"#832A0D"},{"name":"Smoky black","hex":"#100C08"},{"name":"Soap","hex":"#CEC8EF"},{"name":"Solid pink","hex":"#893843"},{"name":"Sonic silver","hex":"#757575"},{"name":"Spartan Crimson","hex":"#9E1316"},{"name":"Space cadet","hex":"#1D2951"},{"name":"Spanish blue","hex":"#0070B8"},{"name":"Spanish carmine","hex":"#D10047"},{"name":"Spanish crimson","hex":"#E51A4C"},{"name":"Spanish gray","hex":"#989898"},{"name":"Spanish green","hex":"#009150"},{"name":"Spanish orange","hex":"#E86100"},{"name":"Spanish pink","hex":"#F7BFBE"},{"name":"Spanish purple","hex":"#66033C"},{"name":"Spanish red","hex":"#E60026"},{"name":"Spanish sky blue","hex":"#00FFFF"},{"name":"Spanish violet","hex":"#4C2882"},{"name":"Spanish viridian","hex":"#007F5C"},{"name":"Spanish yellow","hex":"#F6B511"},{"name":"Spicy mix","hex":"#8B5F4D"},{"name":"Spring bud","hex":"#A7FC00"},{"name":"Spring Frost","hex":"#87FF2A"},{"name":"Spring green","hex":"#00FF7F"},{"name":"Star command blue","hex":"#007BB8"},{"name":"Steel blue","hex":"#4682B4"},{"name":"Steel pink","hex":"#CC33CC"},{"name":"Steel teal","hex":"#5F8A8F"},{"name":"Stil de grain yellow","hex":"#FADA5E"},{"name":"Stop red","hex":"#CF142B"},{"name":"Straw","hex":"#E4D96F"},{"name":"Strawberry","hex":"#FC5A8D"},{"name":"Strawberry red","hex":"#C83F49"},{"name":"Sugar plum","hex":"#914E75"},{"name":"Sunglow","hex":"#FFCC33"},{"name":"Sunray","hex":"#E3AB57"},{"name":"Sunset","hex":"#FAD6A5"},{"name":"Sunset orange","hex":"#FD5E53"},{"name":"Super pink","hex":"#CF6BA9"},{"name":"Sweet Brown","hex":"#A83731"},{"name":"Tan","hex":"#D2B48C"},{"name":"Tangelo","hex":"#F94D00"},{"name":"Tangerine","hex":"#F28500"},{"name":"Tangerine yellow","hex":"#FFCC00"},{"name":"Tango pink","hex":"#E4717A"},{"name":"Tart Orange","hex":"#FB4D46"},{"name":"Taupe","hex":"#483C32"},{"name":"Taupe gray","hex":"#8B8589"},{"name":"Tea green","hex":"#D0F0C0"},{"name":"Tea rose","hex":"#F88379"},{"name":"Teal","hex":"#008080"},{"name":"Teal blue","hex":"#367588"},{"name":"Teal deer","hex":"#99E6B3"},{"name":"Teal green","hex":"#00827F"},{"name":"Telemagenta","hex":"#CF3476"},{"name":"Terra cotta","hex":"#E2725B"},{"name":"Thistle","hex":"#D8BFD8"},{"name":"Thulian pink","hex":"#DE6FA1"},{"name":"Tickle Me Pink","hex":"#FC89AC"},{"name":"Tiffany Blue","hex":"#81D8D0"},{"name":"Tiger's eye","hex":"#E08D3C"},{"name":"Timberwolf","hex":"#DBD7D2"},{"name":"Titanium","hex":"#878681"},{"name":"Titanium yellow","hex":"#EEE600"},{"name":"Tomato","hex":"#FF6347"},{"name":"Tomato sauce","hex":"#B21807"},{"name":"Topaz","hex":"#FFC87C"},{"name":"Tractor red","hex":"#FD0E35"},{"name":"Trolley gray","hex":"#808080"},{"name":"Tropical rain forest","hex":"#00755E"},{"name":"True blue","hex":"#0073CF"},{"name":"Tufts blue","hex":"#3E8EDE"},{"name":"Tulip","hex":"#FF878D"},{"name":"Tumbleweed","hex":"#DEAA88"},{"name":"Turkish rose","hex":"#B57281"},{"name":"Turquoise","hex":"#40E0D0"},{"name":"Turquoise green","hex":"#A0D6B4"},{"name":"Tuscan brown","hex":"#6F4E37"},{"name":"Tuscan red","hex":"#7C4848"},{"name":"Tuscan tan","hex":"#A67B5B"},{"name":"Tuscany","hex":"#C09999"},{"name":"Twilight lavender","hex":"#8A496B"},{"name":"Tyrian purple","hex":"#66023C"},{"name":"Ultramarine","hex":"#3F00FF"},{"name":"Ultramarine blue","hex":"#4166F5"},{"name":"Ultra pink","hex":"#FF6FFF"},{"name":"Ultra red","hex":"#FC6C85"},{"name":"Umber","hex":"#635147"},{"name":"Unbleached silk","hex":"#FFDDCA"},{"name":"United Nations blue","hex":"#5B92E5"},{"name":"Unmellow yellow","hex":"#FFFF66"},{"name":"Upsdell red","hex":"#AE2029"},{"name":"Urobilin","hex":"#E1AD21"},{"name":"Vampire Black","hex":"#080808"},{"name":"Van Dyke brown","hex":"#664228"},{"name":"Vanilla","hex":"#F3E5AB"},{"name":"Vanilla ice","hex":"#F38FA9"},{"name":"Vegas gold","hex":"#C5B358"},{"name":"Venetian red","hex":"#C80815"},{"name":"Verdigris","hex":"#43B3AE"},{"name":"Vermilion","hex":"#E34234"},{"name":"Veronica","hex":"#A020F0"},{"name":"Very light azure","hex":"#74BBFB"},{"name":"Very light blue","hex":"#6666FF"},{"name":"Very light malachite green","hex":"#64E986"},{"name":"Very light tangelo","hex":"#FFB077"},{"name":"Very pale orange","hex":"#FFDFBF"},{"name":"Very pale yellow","hex":"#FFFFBF"},{"name":"Vine Green","hex":"#38A32A"},{"name":"Violet","hex":"#8F00FF"},{"name":"Violet-blue","hex":"#324AB2"},{"name":"Viridian","hex":"#40826D"},{"name":"Viridian green","hex":"#009698"},{"name":"Vista blue","hex":"#7C9ED9"},{"name":"Vivid amber","hex":"#CC9900"},{"name":"Vivid auburn","hex":"#922724"},{"name":"Vivid burgundy","hex":"#9F1D35"},{"name":"Vivid cerise","hex":"#DA1D81"},{"name":"Vivid cerulean","hex":"#00AAEE"},{"name":"Vivid crimson","hex":"#CC0033"},{"name":"Vivid gamboge","hex":"#FF9900"},{"name":"Vivid lime green","hex":"#A6D608"},{"name":"Vivid mulberry","hex":"#B80CE3"},{"name":"Vivid orange","hex":"#FF5F00"},{"name":"Vivid orange peel","hex":"#FFA000"},{"name":"Vivid orchid","hex":"#CC00FF"},{"name":"Vivid raspberry","hex":"#FF006C"},{"name":"Vivid red","hex":"#F70D1A"},{"name":"Vivid sky blue","hex":"#00CCFF"},{"name":"Vivid tangelo","hex":"#F07427"},{"name":"Vivid vermilion","hex":"#E56024"},{"name":"Vivid violet","hex":"#9F00FF"},{"name":"Vivid yellow","hex":"#FFE302"},{"name":"Volt","hex":"#CEFF00"},{"name":"Water","hex":"#D4F1F9"},{"name":"Watermelon","hex":"#F05C85"},{"name":"Watermelon red","hex":"#BF4147"},{"name":"Waterspout","hex":"#A4F4F9"},{"name":"Wenge","hex":"#645452"},{"name":"Wheat","hex":"#F5DEB3"},{"name":"White","hex":"#FFFFFF"},{"name":"White chocolate","hex":"#EDE6D6"},{"name":"White coffee","hex":"#E6E0D4"},{"name":"White smoke","hex":"#F5F5F5"},{"name":"Wild orchid","hex":"#D470A2"},{"name":"Wild Strawberry","hex":"#FF43A4"},{"name":"Wild watermelon","hex":"#FC6C85"},{"name":"Willpower orange","hex":"#FD5800"},{"name":"Windsor tan","hex":"#A75502"},{"name":"Wine","hex":"#722F37"},{"name":"Wine red","hex":"#B11226"},{"name":"Winter Sky","hex":"#FF007C"},{"name":"Wintergreen dream","hex":"#56887D"},{"name":"Wisteria","hex":"#C9A0DC"},{"name":"Wood brown","hex":"#C19A6B"},{"name":"Xanadu","hex":"#738678"},{"name":"Yale blue","hex":"#00356B"},{"name":"Yellow","hex":"#FFFF00"},{"name":"Yellow-green","hex":"#9ACD32"},{"name":"Yellow Orange","hex":"#FFAE42"},{"name":"Yellow rose","hex":"#FFF000"},{"name":"Yellow Sunshine","hex":"#FFF700"},{"name":"YInMn Blue","hex":"#2E5090"},{"name":"Zaffre","hex":"#0014A8"},{"name":"Zebra White","hex":"#F5F5F5"},{"name":"Zomp","hex":"#39A78E"}];

    // Find nearest named color
    function findNearestColorName(hex) {
      const rgb = hexToRgb(hex);
      let nearest = null;
      let minDist = Infinity;

      for (const c of COLOR_NAMES) {
        const cRgb = hexToRgb(c.hex);
        const dist = Math.sqrt(
          Math.pow(rgb[0] - cRgb[0], 2) +
          Math.pow(rgb[1] - cRgb[1], 2) +
          Math.pow(rgb[2] - cRgb[2], 2)
        );
        if (dist < minDist) {
          minDist = dist;
          nearest = c;
        }
      }

      return { name: nearest.name, hex: nearest.hex, distance: minDist };
    }

    // State
    let palette = {
      name: 'My Palette',
      colors: ['#264653', '#2a9d8f', '#e9c46a', '#f4a261', '#e76f51']
    };
    let selectedIndex = null;      // For edit popup
    let selectedIndices = [];      // For multi-selection
    let lastClickedIndex = null;   // For shift+click range selection
    let draggedIndex = null;
    let isGroupDrag = false;
    let gridCols = 4;
    let gridRows = 4;

    let extractImageData = null;
    let batchOriginalColors = null;

    // DOM Elements
    const colorGrid = document.getElementById('colorGrid');
    const gridSizeSelect = document.getElementById('gridSize');
    const paletteNameInput = document.getElementById('paletteName');
    const editPopup = document.getElementById('editPopup');
    const exportPopup = document.getElementById('exportPopup');
    const importPopup = document.getElementById('importPopup');
    const colorPicker = document.getElementById('colorPicker');
    const hexInput = document.getElementById('hexInput');
    const colorPreview = document.getElementById('colorPreview');

    // Initialize
    function init() {
      paletteNameInput.value = palette.name;
      parseGridSize();
      renderGrid();

      // Event listeners
      gridSizeSelect.addEventListener('change', () => {
        parseGridSize();
        renderGrid();
      });

      paletteNameInput.addEventListener('input', (e) => {
        palette.name = e.target.value;
      });

      document.getElementById('squaresToggle').addEventListener('change', (e) => {
        renderGrid();
      });

      // Click outside grid cells to deselect
      document.addEventListener('click', (e) => {
        // Ignore if clicking on a color cell, popup, header control, or button
        if (e.target.closest('.color-cell, .popup-overlay, .header-controls, .batch-edit-btn, .squares-toggle')) return;
        if (selectedIndices.length > 0) {
          selectedIndices = [];
          lastClickedIndex = null;
          renderGrid();
        }
      });

      // Re-render grid when container is resized (for responsive squares)
      // Skip initial resize events to prevent startup animation
      let resizeReady = false;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          resizeReady = true;
        });
      });
      const resizeObserver = new ResizeObserver(() => {
        if (resizeReady && document.getElementById('squaresToggle').checked) {
          renderGrid();
        }
      });
      resizeObserver.observe(document.getElementById('gridContainer'));

      document.getElementById('exportBtn').addEventListener('click', () => {
        exportPopup.classList.add('active');
      });

      document.getElementById('importBtn').addEventListener('click', () => {
        importPopup.classList.add('active');
      });

      document.getElementById('kValue').addEventListener('input', (e) => {
        document.getElementById('kDisplay').textContent = e.target.value;
      });

      document.getElementById('sortColors').addEventListener('change', (e) => {
        if (e.target.value) {
          sortPaletteBy(e.target.value);
          e.target.value = '';
        }
      });

      document.getElementById('randomFillBtn').addEventListener('click', randomFill);

      ['batchHueSlider', 'batchSatSlider', 'batchLightSlider'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateBatchPreview);
      });

      colorPicker.addEventListener('input', (e) => {
        hexInput.value = e.target.value.toUpperCase();
        colorPreview.style.background = e.target.value;
        updateColorName(e.target.value);
        if (sliderMode === 'hsl') {
          updateSlidersFromHex(e.target.value);
        } else {
          updateRgbSlidersFromHex(e.target.value);
        }
      });

      hexInput.addEventListener('input', (e) => {
        let val = e.target.value;
        if (!val.startsWith('#')) val = '#' + val;
        if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
          colorPicker.value = val;
          colorPreview.style.background = val;
          if (sliderMode === 'hsl') {
            updateSlidersFromHex(val);
          } else {
            updateRgbSlidersFromHex(val);
          }
          updateColorName(val);
        }
      });

      // HSL sliders
      const hueSlider = document.getElementById('hueSlider');
      const satSlider = document.getElementById('satSlider');
      const lightSlider = document.getElementById('lightSlider');

      const updateFromSliders = () => {
        const h = parseInt(hueSlider.value);
        const s = parseInt(satSlider.value);
        const l = parseInt(lightSlider.value);
        document.getElementById('hueValue').textContent = h + '°';
        document.getElementById('satValue').textContent = s + '%';
        document.getElementById('lightValue').textContent = l + '%';
        const rgb = hslToRgb(h, s, l);
        const hex = rgbToHex(...rgb);
        hexInput.value = hex;
        colorPicker.value = hex;
        colorPreview.style.background = hex;
        updateColorName(hex);
      };

      hueSlider.addEventListener('input', updateFromSliders);
      satSlider.addEventListener('input', updateFromSliders);
      lightSlider.addEventListener('input', updateFromSliders);

      // RGB sliders
      const redSlider = document.getElementById('redSlider');
      const greenSlider = document.getElementById('greenSlider');
      const blueSlider = document.getElementById('blueSlider');

      const updateFromRgbSliders = () => {
        const r = parseInt(redSlider.value);
        const g = parseInt(greenSlider.value);
        const b = parseInt(blueSlider.value);
        document.getElementById('redValue').textContent = r;
        document.getElementById('greenValue').textContent = g;
        document.getElementById('blueValue').textContent = b;
        const hex = rgbToHex(r, g, b);
        hexInput.value = hex;
        colorPicker.value = hex;
        colorPreview.style.background = hex;
        updateColorName(hex);
      };

      redSlider.addEventListener('input', updateFromRgbSliders);
      greenSlider.addEventListener('input', updateFromRgbSliders);
      blueSlider.addEventListener('input', updateFromRgbSliders);

      // Color name autocomplete
      const colorNameInput = document.getElementById('colorNameInput');
      colorNameInput.addEventListener('input', (e) => {
        const matches = searchColorNames(e.target.value);
        showColorNameDropdown(matches);
      });

      colorNameInput.addEventListener('focus', (e) => {
        if (e.target.value.length >= 2) {
          const matches = searchColorNames(e.target.value);
          showColorNameDropdown(matches);
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.color-name-input-wrapper')) {
          document.getElementById('colorNameDropdown').classList.remove('active');
        }
      });

      // Close popups on overlay click
      editPopup.addEventListener('click', (e) => {
        if (e.target === editPopup) closeEditPopup();
      });
      exportPopup.addEventListener('click', (e) => {
        if (e.target === exportPopup) closeExportPopup();
      });
      importPopup.addEventListener('click', (e) => {
        if (e.target === importPopup) closeImportPopup();
      });

      // Keyboard
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          if (e.key === 'Escape') {
            e.target.blur();
          }
          return;
        }

        const isMod = e.metaKey || e.ctrlKey;

        if (e.key === 'Escape') {
          if (document.getElementById('batchEditPopup').classList.contains('active')) {
            closeBatchEdit();
          } else {
            closeEditPopup();
            closeExportPopup();
            closeImportPopup();
            selectedIndices = [];
            renderGrid();
          }
        }

        // Delete selected colors
        if ((e.key === 'Delete' || e.key === 'Backspace') && selectedIndices.length > 0) {
          e.preventDefault();
          deleteSelectedColors();
        }

        // Cmd/Ctrl + A: Select all
        if (isMod && e.key === 'a') {
          e.preventDefault();
          selectedIndices = palette.colors.map((_, i) => i);
          lastClickedIndex = 0;
          renderGrid();
        }

        // Cmd/Ctrl + C: Copy selected colors
        if (isMod && e.key === 'c' && selectedIndices.length > 0) {
          e.preventDefault();
          copySelectedColors();
        }

        // Cmd/Ctrl + V: Paste colors
        if (isMod && e.key === 'v') {
          e.preventDefault();
          pasteColors();
        }

        // Cmd/Ctrl + D: Duplicate selected colors
        if (isMod && e.key === 'd' && selectedIndices.length > 0) {
          e.preventDefault();
          duplicateSelectedColors();
        }

        // Cmd/Ctrl + E: Batch edit selected colors
        if (isMod && e.key === 'e' && selectedIndices.length >= 2) {
          e.preventDefault();
          openBatchEdit();
        }
      });
    }

    function parseGridSize() {
      const [cols, rows] = gridSizeSelect.value.split('x').map(Number);
      gridCols = cols;
      gridRows = rows;
    }

    function addRow() {
      gridRows++;
      renderGrid();
    }

    function addColumn() {
      gridCols++;
      renderGrid();
    }

    function deleteRow(rowIndex) {
      if (gridRows <= 1) return;
      const startIdx = rowIndex * gridCols;
      const endIdx = startIdx + gridCols;
      // Remove colors in this row (if any exist)
      const colorsToRemove = Math.min(endIdx, palette.colors.length) - Math.min(startIdx, palette.colors.length);
      if (colorsToRemove > 0 && startIdx < palette.colors.length) {
        palette.colors.splice(startIdx, Math.min(gridCols, palette.colors.length - startIdx));
      }
      gridRows--;
      renderGrid();
    }

    function deleteColumn(colIndex) {
      if (gridCols <= 1) return;
      // Remove colors at this column index from each row (bottom to top to preserve indices)
      for (let row = gridRows - 1; row >= 0; row--) {
        const idx = row * gridCols + colIndex;
        if (idx < palette.colors.length) {
          palette.colors.splice(idx, 1);
        }
      }
      gridCols--;
      renderGrid();
    }

    function renderGridControls() {
      const topControls = document.getElementById('topControls');
      const leftControls = document.getElementById('leftControls');
      const rightControls = document.getElementById('rightControls');
      const bottomControls = document.getElementById('bottomControls');

      // Clear existing controls
      topControls.innerHTML = '';
      leftControls.innerHTML = '';
      rightControls.innerHTML = '';
      bottomControls.innerHTML = '';

      // Create delete buttons for each column (top)
      for (let col = 0; col < gridCols; col++) {
        const btn = document.createElement('button');
        btn.className = 'grid-ctrl-btn delete';
        btn.innerHTML = '×';
        btn.title = `Delete column ${col + 1}`;
        btn.onclick = () => deleteColumn(col);
        topControls.appendChild(btn);
      }

      // Create delete buttons for each row (left)
      for (let row = 0; row < gridRows; row++) {
        const btn = document.createElement('button');
        btn.className = 'grid-ctrl-btn delete';
        btn.innerHTML = '×';
        btn.title = `Delete row ${row + 1}`;
        btn.onclick = () => deleteRow(row);
        leftControls.appendChild(btn);
      }

      // Add column button (right)
      const addColBtn = document.createElement('button');
      addColBtn.className = 'grid-ctrl-btn add';
      addColBtn.innerHTML = '+';
      addColBtn.title = 'Add column';
      addColBtn.onclick = addColumn;
      rightControls.appendChild(addColBtn);

      // Add row button (bottom)
      const addRowBtn = document.createElement('button');
      addRowBtn.className = 'grid-ctrl-btn add';
      addRowBtn.innerHTML = '+';
      addRowBtn.title = 'Add row';
      addRowBtn.onclick = addRow;
      bottomControls.appendChild(addRowBtn);
    }

    function renderGrid() {
      colorGrid.innerHTML = '';

      const isSquares = document.getElementById('squaresToggle').checked;
      const container = document.getElementById('gridContainer');
      const gridArea = document.getElementById('gridArea');
      const gap = 8; // matches CSS gap

      if (isSquares) {
        // Calculate cell size to fit container while maintaining square aspect ratio
        const availableWidth = container.clientWidth - 40; // 20px padding each side
        const availableHeight = container.clientHeight - 48 - 24; // 20px top + 28px bottom padding, 24px margin-top

        const maxCellWidth = (availableWidth - gap * (gridCols - 1)) / gridCols;
        const maxCellHeight = (availableHeight - gap * (gridRows - 1)) / gridRows;
        const cellSize = Math.max(24, Math.min(maxCellWidth, maxCellHeight)); // min 24px

        gridArea.style.display = 'inline-block';
        gridArea.style.width = 'auto';
        gridArea.style.height = 'auto';
        colorGrid.style.gridTemplateColumns = `repeat(${gridCols}, ${cellSize}px)`;
        colorGrid.style.gridTemplateRows = `repeat(${gridRows}, ${cellSize}px)`;
        colorGrid.style.height = 'auto';
      } else {
        // Free mode: fill container with flexible cells
        gridArea.style.display = 'block';
        gridArea.style.width = '100%';
        gridArea.style.height = 'calc(100% - 24px)';
        colorGrid.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;
        colorGrid.style.gridTemplateRows = `repeat(${gridRows}, 1fr)`;
        colorGrid.style.height = '100%';
      }

      // Set container min-size based on grid dimensions (min cell size = 24px)
      const minCellSize = 24;
      const minGridWidth = gridCols * minCellSize + (gridCols - 1) * gap;
      const minGridHeight = gridRows * minCellSize + (gridRows - 1) * gap;
      container.style.minWidth = (minGridWidth + 40) + 'px'; // 40px = padding
      container.style.minHeight = (minGridHeight + 72) + 'px'; // 72px = padding + margin

      const totalCells = gridCols * gridRows;

      for (let i = 0; i < totalCells; i++) {
        const wrapper = document.createElement('div');
        wrapper.className = 'grid-cell-wrapper';

        const cell = document.createElement('div');
        cell.className = 'color-cell';

        const row = Math.floor(i / gridCols);
        const col = i % gridCols;
        const colorIndex = i;
        const hasColor = i < palette.colors.length;
        const hasRightNeighbor = col < gridCols - 1 && (i + 1) < palette.colors.length;
        const hasBottomNeighbor = (i + gridCols) < palette.colors.length;

        if (hasColor) {
          cell.style.background = palette.colors[i];
          cell.draggable = true;
          cell.dataset.index = i;

          // Multi-selection highlight
          if (selectedIndices.includes(i)) {
            cell.classList.add('multi-selected');
          }

          cell.addEventListener('click', (e) => handleColorClick(i, e));

          // Drag events
          cell.addEventListener('dragstart', (e) => {
            draggedIndex = i;
            isGroupDrag = selectedIndices.includes(i) && selectedIndices.length > 1;
            cell.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            if (isGroupDrag) {
              // Add visual cue to all selected cells
              document.querySelectorAll('.color-cell').forEach((c, idx) => {
                if (selectedIndices.includes(idx) && idx !== i) c.classList.add('group-dragging');
              });
              // Show count badge on dragged cell
              const badge = document.createElement('div');
              badge.className = 'drag-count-badge';
              badge.textContent = selectedIndices.length;
              cell.style.position = 'relative';
              cell.appendChild(badge);
            }
          });

          cell.addEventListener('dragend', () => {
            cell.classList.remove('dragging');
            document.querySelectorAll('.drag-over, .group-dragging').forEach(el => {
              el.classList.remove('drag-over', 'group-dragging');
            });
            document.querySelectorAll('.drag-count-badge').forEach(el => el.remove());
            draggedIndex = null;
            isGroupDrag = false;
          });

          cell.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (draggedIndex !== null && draggedIndex !== i) {
              cell.classList.add('drag-over');
            }
          });

          cell.addEventListener('dragleave', () => {
            cell.classList.remove('drag-over');
          });

          cell.addEventListener('drop', (e) => {
            e.preventDefault();
            cell.classList.remove('drag-over');
            if (draggedIndex !== null && draggedIndex !== i) {
              if (isGroupDrag) {
                reorderMultiple(selectedIndices, i);
              } else {
                reorderColors(draggedIndex, i);
              }
            }
          });

          // Right interpolation button (between two colors)
          if (hasRightNeighbor) {
            const rightBtn = document.createElement('button');
            rightBtn.className = 'interp-btn right';
            rightBtn.innerHTML = '+';
            rightBtn.title = 'Add interpolated color';
            rightBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              insertInterpolated(colorIndex, colorIndex + 1, colorIndex + 1);
            });
            wrapper.appendChild(rightBtn);
          }

          // Right extrapolation button (at frontier - last color before empty space)
          const isFrontier = col < gridCols - 1 && colorIndex === palette.colors.length - 1 && colorIndex > 0;
          if (isFrontier) {
            const extrapBtn = document.createElement('button');
            extrapBtn.className = 'interp-btn right';
            extrapBtn.innerHTML = '+';
            extrapBtn.title = 'Extrapolate color (extend gradient)';
            extrapBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              insertExtrapolated(colorIndex - 1, colorIndex);
            });
            wrapper.appendChild(extrapBtn);
          }

          // Bottom interpolation button (for grid navigation)
          if (hasBottomNeighbor) {
            const bottomBtn = document.createElement('button');
            bottomBtn.className = 'interp-btn bottom';
            bottomBtn.innerHTML = '+';
            bottomBtn.title = 'Add interpolated color';
            bottomBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              insertInterpolated(colorIndex, colorIndex + gridCols, colorIndex + gridCols);
            });
            wrapper.appendChild(bottomBtn);
          }
        } else {
          cell.className = 'color-cell empty';
          cell.addEventListener('click', () => addColor(i));

          // Allow dropping colors onto empty cells to move them to the end
          cell.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (draggedIndex !== null) {
              cell.classList.add('drag-over');
            }
          });
          cell.addEventListener('dragleave', () => {
            cell.classList.remove('drag-over');
          });
          cell.addEventListener('drop', (e) => {
            e.preventDefault();
            cell.classList.remove('drag-over');
            if (draggedIndex !== null) {
              if (isGroupDrag) {
                reorderMultiple(selectedIndices, palette.colors.length);
              } else {
                reorderColors(draggedIndex, palette.colors.length);
              }
            }
          });
        }

        wrapper.appendChild(cell);
        colorGrid.appendChild(wrapper);
      }

      renderGridControls();

      // Show/hide overflow warning
      const overflowWarning = document.getElementById('overflowWarning');
      if (overflowWarning) overflowWarning.style.display = palette.colors.length > gridCols * gridRows ? 'inline' : 'none';

      // Show/hide batch edit button
      const batchBtn = document.getElementById('batchEditBtn');
      if (batchBtn) batchBtn.style.display = selectedIndices.length >= 2 ? 'inline-block' : 'none';
    }

    function handleColorClick(index, e) {
      if (e.metaKey || e.ctrlKey) {
        // Cmd/Ctrl+click: toggle in multi-selection
        const idx = selectedIndices.indexOf(index);
        if (idx > -1) {
          selectedIndices.splice(idx, 1);
        } else {
          selectedIndices.push(index);
        }
        lastClickedIndex = index;
        renderGrid();
      } else if (e.shiftKey) {
        // Shift+click: range select (or start new selection if no anchor)
        if (lastClickedIndex !== null) {
          const start = Math.min(lastClickedIndex, index);
          const end = Math.max(lastClickedIndex, index);
          selectedIndices = [];
          for (let i = start; i <= end && i < palette.colors.length; i++) {
            selectedIndices.push(i);
          }
        } else {
          // No anchor yet: select this tile as the starting point
          selectedIndices = [index];
          lastClickedIndex = index;
        }
        renderGrid();
      } else {
        // Normal click: open edit popup, clear multi-selection
        selectedIndices = [index];
        lastClickedIndex = index;
        openEditPopup(index);
      }
    }

    function openEditPopup(index) {
      selectedIndex = index;
      const color = palette.colors[index];
      colorPicker.value = color;
      hexInput.value = color.toUpperCase();
      colorPreview.style.background = color;

      // Reset to HSL mode
      sliderMode = 'hsl';
      document.getElementById('hslSliders').style.display = 'flex';
      document.getElementById('rgbSliders').style.display = 'none';
      document.getElementById('modeToggle').textContent = '⇄ RGB';

      updateSlidersFromHex(color);
      updateColorName(color);
      document.getElementById('colorNameDropdown').classList.remove('active');
      editPopup.classList.add('active');
    }

    function updateColorName(hex) {
      const nearest = findNearestColorName(hex);
      document.getElementById('colorNameInput').value = nearest.name;
    }

    // Slider mode toggle
    let sliderMode = 'hsl';

    function toggleSliderMode() {
      if (sliderMode === 'hsl') {
        sliderMode = 'rgb';
        document.getElementById('hslSliders').style.display = 'none';
        document.getElementById('rgbSliders').style.display = 'flex';
        document.getElementById('modeToggle').textContent = '⇄ HSL';
        updateRgbSlidersFromHex(hexInput.value);
      } else {
        sliderMode = 'hsl';
        document.getElementById('hslSliders').style.display = 'flex';
        document.getElementById('rgbSliders').style.display = 'none';
        document.getElementById('modeToggle').textContent = '⇄ RGB';
        updateSlidersFromHex(hexInput.value);
      }
    }

    function updateRgbSlidersFromHex(hex) {
      const rgb = hexToRgb(hex);
      document.getElementById('redSlider').value = rgb[0];
      document.getElementById('greenSlider').value = rgb[1];
      document.getElementById('blueSlider').value = rgb[2];
      document.getElementById('redValue').textContent = rgb[0];
      document.getElementById('greenValue').textContent = rgb[1];
      document.getElementById('blueValue').textContent = rgb[2];
    }

    // Color name autocomplete
    function searchColorNames(query) {
      if (!query || query.length < 2) return [];
      const lowerQuery = query.toLowerCase();
      return COLOR_NAMES
        .filter(c => c.name.toLowerCase().includes(lowerQuery))
        .slice(0, 5);
    }

    function showColorNameDropdown(matches) {
      const dropdown = document.getElementById('colorNameDropdown');
      if (matches.length === 0) {
        dropdown.classList.remove('active');
        return;
      }

      dropdown.innerHTML = matches.map(c => `
        <div class="color-name-option" onclick="selectColorName('${c.hex}', '${c.name.replace(/'/g, "\\'")}')">
          <div class="color-name-swatch" style="background: ${c.hex}"></div>
          <span class="color-name-text">${c.name}</span>
        </div>
      `).join('');
      dropdown.classList.add('active');
    }

    function selectColorName(hex, name) {
      hexInput.value = hex;
      colorPicker.value = hex;
      colorPreview.style.background = hex;
      document.getElementById('colorNameInput').value = name;
      document.getElementById('colorNameDropdown').classList.remove('active');
      if (sliderMode === 'hsl') {
        updateSlidersFromHex(hex);
      } else {
        updateRgbSlidersFromHex(hex);
      }
    }

    function updateSlidersFromHex(hex) {
      const rgb = hexToRgb(hex);
      const hsl = rgbToHsl(...rgb);
      document.getElementById('hueSlider').value = Math.round(hsl[0]);
      document.getElementById('satSlider').value = Math.round(hsl[1]);
      document.getElementById('lightSlider').value = Math.round(hsl[2]);
      document.getElementById('hueValue').textContent = Math.round(hsl[0]) + '°';
      document.getElementById('satValue').textContent = Math.round(hsl[1]) + '%';
      document.getElementById('lightValue').textContent = Math.round(hsl[2]) + '%';
    }

    function closeEditPopup() {
      editPopup.classList.remove('active');
      selectedIndex = null;
      selectedIndices = [];
      lastClickedIndex = null;
      renderGrid();
    }

    function closeExportPopup() {
      exportPopup.classList.remove('active');
    }

    function openBatchEdit() {
      if (selectedIndices.length < 2) return;
      batchOriginalColors = selectedIndices.map(i => palette.colors[i]);
      document.getElementById('batchHueSlider').value = 0;
      document.getElementById('batchSatSlider').value = 0;
      document.getElementById('batchLightSlider').value = 0;
      document.getElementById('batchHueValue').textContent = '0°';
      document.getElementById('batchSatValue').textContent = '0%';
      document.getElementById('batchLightValue').textContent = '0%';
      updateBatchPreview();
      document.getElementById('batchEditPopup').classList.add('active');
    }

    function closeBatchEdit() {
      if (batchOriginalColors) {
        selectedIndices.forEach((idx, i) => {
          palette.colors[idx] = batchOriginalColors[i];
        });
        batchOriginalColors = null;
      }
      document.getElementById('batchEditPopup').classList.remove('active');
      renderGrid();
    }

    function applyBatchEdit() {
      batchOriginalColors = null;
      document.getElementById('batchEditPopup').classList.remove('active');
      renderGrid();
    }

    function updateBatchPreview() {
      if (!batchOriginalColors) return;
      const dH = parseInt(document.getElementById('batchHueSlider').value);
      const dS = parseInt(document.getElementById('batchSatSlider').value);
      const dL = parseInt(document.getElementById('batchLightSlider').value);
      document.getElementById('batchHueValue').textContent = (dH >= 0 ? '+' : '') + dH + '°';
      document.getElementById('batchSatValue').textContent = (dS >= 0 ? '+' : '') + dS + '%';
      document.getElementById('batchLightValue').textContent = (dL >= 0 ? '+' : '') + dL + '%';
      const previewRow = document.getElementById('batchPreviewRow');
      previewRow.innerHTML = '';
      batchOriginalColors.forEach((origHex, i) => {
        const rgb = hexToRgb(origHex);
        const hsl = rgbToHsl(...rgb);
        const newH = ((hsl[0] + dH) % 360 + 360) % 360;
        const newS = Math.max(0, Math.min(100, hsl[1] + dS));
        const newL = Math.max(0, Math.min(100, hsl[2] + dL));
        const newRgb = hslToRgb(newH, newS, newL);
        const newHex = rgbToHex(...newRgb);
        palette.colors[selectedIndices[i]] = newHex;
        const swatch = document.createElement('div');
        swatch.className = 'batch-preview-swatch';
        swatch.style.background = newHex;
        previewRow.appendChild(swatch);
      });
      renderGrid();
    }

    function saveColor() {
      if (selectedIndex === null) return;
      let color = hexInput.value.toUpperCase();
      if (!color.startsWith('#')) color = '#' + color;
      if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
        palette.colors[selectedIndex] = color;
        renderGrid();
        closeEditPopup();
      }
    }

    function deleteColor() {
      if (selectedIndex === null) return;
      palette.colors.splice(selectedIndex, 1);
      renderGrid();
      closeEditPopup();
    }

    function duplicateColor() {
      if (selectedIndex === null) return;
      const color = hexInput.value.toUpperCase().startsWith('#') ? hexInput.value.toUpperCase() : '#' + hexInput.value.toUpperCase();
      palette.colors.splice(selectedIndex + 1, 0, color);
      renderGrid();
      closeEditPopup();
    }

    function reorderColors(fromIndex, toIndex) {
      const color = palette.colors.splice(fromIndex, 1)[0];
      palette.colors.splice(toIndex, 0, color);
      renderGrid();
    }

    function reorderMultiple(indices, toIndex) {
      const sorted = [...indices].sort((a, b) => a - b);
      const colors = sorted.map(i => palette.colors[i]);
      // Remove from high to low to preserve earlier indices
      for (let i = sorted.length - 1; i >= 0; i--) {
        palette.colors.splice(sorted[i], 1);
      }
      // Use toIndex directly (matches single-drag splice behavior), clamped to valid range
      const insertAt = Math.min(toIndex, palette.colors.length);
      palette.colors.splice(insertAt, 0, ...colors);
      selectedIndices = colors.map((_, i) => insertAt + i);
      renderGrid();
    }

    function sortPaletteBy(method) {
      const visibleCount = Math.min(palette.colors.length, gridCols * gridRows);
      const visible = palette.colors.slice(0, visibleCount);
      const rest = palette.colors.slice(visibleCount);
      visible.sort((a, b) => {
        const hslA = rgbToHsl(...hexToRgb(a));
        const hslB = rgbToHsl(...hexToRgb(b));

        switch (method) {
          case 'hue': {
            // Bucket into 12 groups of 30° with 15° offset (reds 345°-15° stay together)
            const bucket = h => Math.floor(((h + 15) % 360) / 30);
            const bA = bucket(hslA[0]), bB = bucket(hslB[0]);
            if (bA !== bB) return bA - bB;
            // Within same bucket, sort by actual hue
            if (Math.abs(hslA[0] - hslB[0]) > 1) return hslA[0] - hslB[0];
            return hslA[2] - hslB[2];
          }
          case 'saturation':
            return hslA[1] - hslB[1];
          case 'lightness':
            return hslA[2] - hslB[2];
          case 'luminance':
            const rgbA = hexToRgb(a);
            const rgbB = hexToRgb(b);
            const lumA = 0.299 * rgbA[0] + 0.587 * rgbA[1] + 0.114 * rgbA[2];
            const lumB = 0.299 * rgbB[0] + 0.587 * rgbB[1] + 0.114 * rgbB[2];
            return lumA - lumB;
          default:
            return 0;
        }
      });
      palette.colors = visible.concat(rest);
      selectedIndices = [];
      renderGrid();
    }

    function randomFill() {
      const totalCells = gridCols * gridRows;
      const randomHex = () => '#' + Math.floor(Math.random() * 0xFFFFFF).toString(16).padStart(6, '0').toUpperCase();

      if (palette.colors.length === 0 || palette.colors.length >= totalCells) {
        // Empty or full grid: generate entirely new palette
        palette.colors = [];
        for (let i = 0; i < totalCells; i++) {
          palette.colors.push(randomHex());
        }
      } else {
        // Partially filled: fill remaining empty cells
        const emptyCount = totalCells - palette.colors.length;
        for (let i = 0; i < emptyCount; i++) {
          palette.colors.push(randomHex());
        }
      }
      selectedIndices = [];
      renderGrid();
    }

    function deleteSelectedColors() {
      if (selectedIndices.length === 0) return;
      // Sort descending so we remove from end first (preserves indices)
      const sorted = [...selectedIndices].sort((a, b) => b - a);
      sorted.forEach(idx => {
        if (idx < palette.colors.length) {
          palette.colors.splice(idx, 1);
        }
      });
      selectedIndices = [];
      lastClickedIndex = null;
      renderGrid();
    }

    function copySelectedColors() {
      const colors = selectedIndices
        .sort((a, b) => a - b)
        .map(i => palette.colors[i])
        .join('\n');
      navigator.clipboard.writeText(colors).then(() => {
        // Brief visual feedback could be added here
        console.log('Copied:', colors);
      });
    }

    function duplicateSelectedColors() {
      if (selectedIndices.length === 0) return;
      const sorted = [...selectedIndices].sort((a, b) => a - b);
      const colorsToDupe = sorted.map(i => palette.colors[i]);
      // Insert after the last selected index
      const insertAt = Math.max(...sorted) + 1;
      palette.colors.splice(insertAt, 0, ...colorsToDupe);
      // Select the newly duplicated colors
      selectedIndices = colorsToDupe.map((_, i) => insertAt + i);
      lastClickedIndex = insertAt;
      renderGrid();
    }

    async function pasteColors() {
      try {
        const text = await navigator.clipboard.readText();
        const lines = text.split(/[\r\n]+/).filter(l => l.trim());
        const newColors = [];

        for (const line of lines) {
          let hex = line.trim().replace(/^#/, '');
          if (/^[0-9A-Fa-f]{6}$/.test(hex)) {
            newColors.push('#' + hex.toUpperCase());
          }
        }

        if (newColors.length > 0) {
          // Insert after last selected, or at end
          const insertAt = selectedIndices.length > 0
            ? Math.max(...selectedIndices) + 1
            : palette.colors.length;
          palette.colors.splice(insertAt, 0, ...newColors);

          // Select newly pasted colors
          selectedIndices = newColors.map((_, i) => insertAt + i);
          lastClickedIndex = insertAt;
          renderGrid();
        }
      } catch (err) {
        console.log('Paste failed:', err);
      }
    }

    function addColor(index) {
      // Add at the position clicked (or end of current colors)
      const insertAt = Math.min(index, palette.colors.length);
      const newColor = '#888888';
      palette.colors.splice(insertAt, 0, newColor);
      renderGrid();
      openEditPopup(insertAt);
    }

    // Export functions
    function exportPNG() {
      const cellSize = 32;
      const cols = palette.colors.length;
      const canvas = document.createElement('canvas');
      canvas.width = cols * cellSize;
      canvas.height = cellSize;
      const ctx = canvas.getContext('2d');

      palette.colors.forEach((color, i) => {
        ctx.fillStyle = color;
        ctx.fillRect(i * cellSize, 0, cellSize, cellSize);
      });

      const link = document.createElement('a');
      link.download = `${palette.name.replace(/\s+/g, '-').toLowerCase()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    function exportHex() {
      const content = palette.colors.map(c => c.replace('#', '')).join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.download = `${palette.name.replace(/\s+/g, '-').toLowerCase()}.hex`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    function exportJSON() {
      const data = {
        name: palette.name,
        colors: palette.colors
      };
      const content = JSON.stringify(data, null, 2);
      const blob = new Blob([content], { type: 'application/json' });
      const link = document.createElement('a');
      link.download = `${palette.name.replace(/\s+/g, '-').toLowerCase()}.json`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    function exportGPL() {
      let content = 'GIMP Palette\n';
      content += `Name: ${palette.name}\n`;
      content += '#\n';

      palette.colors.forEach(hex => {
        const rgb = hexToRgb(hex);
        content += `${rgb[0].toString().padStart(3)} ${rgb[1].toString().padStart(3)} ${rgb[2].toString().padStart(3)}\t${hex}\n`;
      });

      const blob = new Blob([content], { type: 'text/plain' });
      const link = document.createElement('a');
      link.download = `${palette.name.replace(/\s+/g, '-').toLowerCase()}.gpl`;
      link.href = URL.createObjectURL(blob);
      link.click();
    }

    async function exportSwatches() {
      try {
        // Procreate .swatches format is a ZIP containing Swatches.json
        const zip = new JSZip();

        // Convert colors to Procreate format (HSB with values 0-1)
        const swatches = palette.colors.map(hex => {
          const rgb = hexToRgb(hex);
          // Convert RGB to HSB (HSV)
          const r = rgb[0] / 255, g = rgb[1] / 255, b = rgb[2] / 255;
          const max = Math.max(r, g, b), min = Math.min(r, g, b);
          const d = max - min;

          let h = 0, s = 0, v = max;

          if (max !== 0) {
            s = d / max;
          }

          if (d !== 0) {
            switch (max) {
              case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
              case g: h = ((b - r) / d + 2) / 6; break;
              case b: h = ((r - g) / d + 4) / 6; break;
            }
          }

          return {
            alpha: 1,
            origin: 1,
            colorSpace: 0,
            colorModel: 0,
            brightness: v,
            components: [h, s, v],
            version: "5.0",
            saturation: s,
            hue: h
          };
        });

        const swatchesFile = {
          name: palette.name,
          swatches: swatches
        };

        console.log('Swatches data:', swatchesFile);
        zip.file('Swatches.json', JSON.stringify(swatchesFile));

        const blob = await zip.generateAsync({ type: 'blob' });
        console.log('ZIP blob size:', blob.size);

        const link = document.createElement('a');
        link.download = `${palette.name.replace(/\s+/g, '-').toLowerCase()}.swatches`;
        link.href = URL.createObjectURL(blob);
        link.click();
      } catch (err) {
        console.error('Export failed:', err);
        alert('Export failed: ' + err.message);
      }
    }

    // Import functions
    function closeImportPopup() {
      importPopup.classList.remove('active');
      document.getElementById('extractOptions').style.display = 'none';
      extractImageData = null;
    }

    function importPNG(input) {
      const file = input.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // Sample pixels along the middle row
        const y = Math.floor(img.height / 2);
        const colors = [];
        let lastColor = null;

        for (let x = 0; x < img.width; x++) {
          const pixel = ctx.getImageData(x, y, 1, 1).data;
          const hex = rgbToHex(pixel[0], pixel[1], pixel[2]);

          // Dedupe adjacent same colors
          if (hex !== lastColor) {
            colors.push(hex);
            lastColor = hex;
          }
        }

        if (colors.length > 0) {
          palette.colors = colors;
          palette.name = file.name.replace(/\.[^/.]+$/, '');
          paletteNameInput.value = palette.name;
          renderGrid();
          closeImportPopup();
        }
      };
      img.src = URL.createObjectURL(file);
      input.value = '';
    }

    function importHexFile(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const lines = text.split(/[\r\n]+/).filter(l => l.trim());
        const colors = [];

        for (const line of lines) {
          let hex = line.trim().replace(/^#/, '');
          if (/^[0-9A-Fa-f]{6}$/.test(hex)) {
            colors.push('#' + hex.toUpperCase());
          }
        }

        if (colors.length > 0) {
          palette.colors = colors;
          palette.name = file.name.replace(/\.[^/.]+$/, '');
          paletteNameInput.value = palette.name;
          renderGrid();
          closeImportPopup();
        }
      };
      reader.readAsText(file);
      input.value = '';
    }

    function showExtractOptions(input) {
      const file = input.files[0];
      if (!file) return;

      const img = new Image();
      img.onload = () => {
        const canvas = document.getElementById('previewCanvas');
        const maxWidth = 360;
        const scale = Math.min(1, maxWidth / img.width);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        // Store full-size image data for extraction
        const fullCanvas = document.createElement('canvas');
        fullCanvas.width = img.width;
        fullCanvas.height = img.height;
        const fullCtx = fullCanvas.getContext('2d');
        fullCtx.drawImage(img, 0, 0);
        extractImageData = fullCtx.getImageData(0, 0, img.width, img.height);

        document.getElementById('extractOptions').style.display = 'block';
      };
      img.src = URL.createObjectURL(file);
      input.value = '';
    }

    function extractColors() {
      if (!extractImageData) return;

      const k = parseInt(document.getElementById('kValue').value);
      const mode = document.querySelector('input[name="extractMode"]:checked').value;

      const colors = mode === 'outlier'
        ? kMeansColorsOutlierAware(extractImageData, k)
        : kMeansColors(extractImageData, k);

      palette.colors = colors;
      renderGrid();
      closeImportPopup();
    }

    // K-means clustering
    function kMeansColors(imageData, k) {
      const pixels = [];
      const data = imageData.data;

      // Sample every Nth pixel for performance
      const step = Math.max(1, Math.floor(data.length / 4 / 10000));

      for (let i = 0; i < data.length; i += 4 * step) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        // Skip transparent pixels
        if (a < 128) continue;

        pixels.push([r, g, b]);
      }

      if (pixels.length === 0) return ['#888888'];

      // Initialize centroids randomly
      let centroids = [];
      const shuffled = pixels.slice().sort(() => Math.random() - 0.5);
      for (let i = 0; i < Math.min(k, shuffled.length); i++) {
        centroids.push(shuffled[i].slice());
      }

      // Run k-means iterations
      const maxIterations = 20;
      for (let iter = 0; iter < maxIterations; iter++) {
        // Assign pixels to nearest centroid
        const clusters = Array.from({ length: k }, () => []);

        for (const pixel of pixels) {
          let minDist = Infinity;
          let nearest = 0;

          for (let c = 0; c < centroids.length; c++) {
            const dist = colorDistance(pixel, centroids[c]);
            if (dist < minDist) {
              minDist = dist;
              nearest = c;
            }
          }

          clusters[nearest].push(pixel);
        }

        // Update centroids
        let converged = true;
        for (let c = 0; c < centroids.length; c++) {
          if (clusters[c].length === 0) continue;

          const newCentroid = [0, 0, 0];
          for (const pixel of clusters[c]) {
            newCentroid[0] += pixel[0];
            newCentroid[1] += pixel[1];
            newCentroid[2] += pixel[2];
          }
          newCentroid[0] = Math.round(newCentroid[0] / clusters[c].length);
          newCentroid[1] = Math.round(newCentroid[1] / clusters[c].length);
          newCentroid[2] = Math.round(newCentroid[2] / clusters[c].length);

          if (colorDistance(centroids[c], newCentroid) > 1) {
            converged = false;
          }
          centroids[c] = newCentroid;
        }

        if (converged) break;
      }

      // Sort by luminance and convert to hex
      centroids.sort((a, b) => {
        const lumA = 0.299 * a[0] + 0.587 * a[1] + 0.114 * a[2];
        const lumB = 0.299 * b[0] + 0.587 * b[1] + 0.114 * b[2];
        return lumA - lumB;
      });

      return centroids.map(c => rgbToHex(c[0], c[1], c[2]));
    }

    function colorDistance(c1, c2) {
      const dr = c1[0] - c2[0];
      const dg = c1[1] - c2[1];
      const db = c1[2] - c2[2];
      return Math.sqrt(dr * dr + dg * dg + db * db);
    }

    // Outlier-aware k-means clustering
    function kMeansColorsOutlierAware(imageData, k) {
      const pixels = [];
      const data = imageData.data;

      // Sample every Nth pixel for performance
      const step = Math.max(1, Math.floor(data.length / 4 / 10000));

      for (let i = 0; i < data.length; i += 4 * step) {
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        const a = data[i + 3];

        if (a < 128) continue;
        pixels.push([r, g, b]);
      }

      if (pixels.length === 0) return ['#888888'];

      // Initialize centroids randomly
      let centroids = [];
      const shuffled = pixels.slice().sort(() => Math.random() - 0.5);
      for (let i = 0; i < Math.min(k, shuffled.length); i++) {
        centroids.push(shuffled[i].slice());
      }

      // Run k-means iterations
      const maxIterations = 20;
      let clusters = [];

      for (let iter = 0; iter < maxIterations; iter++) {
        clusters = Array.from({ length: k }, () => []);

        for (const pixel of pixels) {
          let minDist = Infinity;
          let nearest = 0;

          for (let c = 0; c < centroids.length; c++) {
            const dist = colorDistance(pixel, centroids[c]);
            if (dist < minDist) {
              minDist = dist;
              nearest = c;
            }
          }

          clusters[nearest].push(pixel);
        }

        let converged = true;
        for (let c = 0; c < centroids.length; c++) {
          if (clusters[c].length === 0) continue;

          const newCentroid = [0, 0, 0];
          for (const pixel of clusters[c]) {
            newCentroid[0] += pixel[0];
            newCentroid[1] += pixel[1];
            newCentroid[2] += pixel[2];
          }
          newCentroid[0] = Math.round(newCentroid[0] / clusters[c].length);
          newCentroid[1] = Math.round(newCentroid[1] / clusters[c].length);
          newCentroid[2] = Math.round(newCentroid[2] / clusters[c].length);

          if (colorDistance(centroids[c], newCentroid) > 1) {
            converged = false;
          }
          centroids[c] = newCentroid;
        }

        if (converged) break;
      }

      // Find outliers: pixels far from their nearest centroid
      const outlierThreshold = 80; // RGB distance threshold
      const outliers = [];

      for (const pixel of pixels) {
        let minDist = Infinity;
        for (const centroid of centroids) {
          const dist = colorDistance(pixel, centroid);
          if (dist < minDist) minDist = dist;
        }
        if (minDist > outlierThreshold) {
          outliers.push({ pixel, dist: minDist });
        }
      }

      // If we have outliers, replace similar clusters
      if (outliers.length > 0) {
        // Sort outliers by distance (most outlier-y first)
        outliers.sort((a, b) => b.dist - a.dist);

        // Get unique outlier colors (cluster them loosely)
        const uniqueOutliers = [];
        for (const o of outliers) {
          let isUnique = true;
          for (const existing of uniqueOutliers) {
            if (colorDistance(o.pixel, existing) < 50) {
              isUnique = false;
              break;
            }
          }
          if (isUnique) {
            uniqueOutliers.push(o.pixel);
            if (uniqueOutliers.length >= Math.floor(k / 2)) break; // Don't replace more than half
          }
        }

        // For each unique outlier, find and replace the most redundant cluster
        for (const outlierColor of uniqueOutliers) {
          // Find the two most similar centroids
          let minSimilarity = Infinity;
          let similar1 = -1, similar2 = -1;

          for (let i = 0; i < centroids.length; i++) {
            for (let j = i + 1; j < centroids.length; j++) {
              const dist = colorDistance(centroids[i], centroids[j]);
              if (dist < minSimilarity) {
                minSimilarity = dist;
                similar1 = i;
                similar2 = j;
              }
            }
          }

          // If we found similar centroids, replace the smaller cluster
          if (similar1 >= 0 && similar2 >= 0) {
            const replaceIdx = clusters[similar1].length <= clusters[similar2].length ? similar1 : similar2;
            centroids[replaceIdx] = outlierColor.slice();
          }
        }
      }

      // Sort by luminance and convert to hex
      centroids.sort((a, b) => {
        const lumA = 0.299 * a[0] + 0.587 * a[1] + 0.114 * a[2];
        const lumB = 0.299 * b[0] + 0.587 * b[1] + 0.114 * b[2];
        return lumA - lumB;
      });

      return centroids.map(c => rgbToHex(c[0], c[1], c[2]));
    }

    function rgbToHex(r, g, b) {
      return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
      ] : [128, 128, 128];
    }

    function rgbToHsl(r, g, b) {
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0;
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }
      return [h * 360, s * 100, l * 100];
    }

    function hslToRgb(h, s, l) {
      h /= 360; s /= 100; l /= 100;
      let r, g, b;

      if (s === 0) {
        r = g = b = l;
      } else {
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        r = hue2rgb(p, q, h + 1/3);
        g = hue2rgb(p, q, h);
        b = hue2rgb(p, q, h - 1/3);
      }
      return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
    }

    function interpolateColor(hex1, hex2, t = 0.5) {
      // Interpolate in HSL space with chroma damping for distant hues
      const rgb1 = hexToRgb(hex1);
      const rgb2 = hexToRgb(hex2);
      const hsl1 = rgbToHsl(...rgb1);
      const hsl2 = rgbToHsl(...rgb2);

      let h1 = hsl1[0], h2 = hsl2[0];
      const s1 = hsl1[1], s2 = hsl2[1];
      const l1 = hsl1[2], l2 = hsl2[2];

      // Shortest angular path
      let diff = h2 - h1;
      if (diff > 180) diff -= 360;
      if (diff < -180) diff += 360;

      const h = (h1 + diff * t + 360) % 360;
      let s = s1 + (s2 - s1) * t;
      const l = l1 + (l2 - l1) * t;

      // Chroma damping: reduce saturation for distant hues
      const hueDist = Math.abs(diff) / 180; // 0 = same hue, 1 = opposite
      const dampingFactor = 0.6;
      s = s * (1 - hueDist * dampingFactor);

      const rgb = hslToRgb(h, s, l);
      return rgbToHex(...rgb);
    }

    function insertInterpolated(index1, index2, insertAt) {
      const color1 = palette.colors[index1];
      const color2 = palette.colors[index2];
      const newColor = interpolateColor(color1, color2);
      palette.colors.splice(insertAt, 0, newColor);
      renderGrid();
    }

    function insertExtrapolated(prevIndex, currentIndex) {
      // Extrapolate beyond currentIndex using the direction from prev to current
      // HSL hue is circular so no gamut walls - can use larger t
      const color1 = palette.colors[prevIndex];
      const color2 = palette.colors[currentIndex];
      const newColor = interpolateColor(color1, color2, 1.5);
      palette.colors.push(newColor);
      renderGrid();
    }

    // Start
    init();
  </script>
</body>
</html>
